{
  "version": 4,
  "terraform_version": "0.14.6",
  "serial": 180,
  "lineage": "ac72d9db-dcdb-04c6-1992-7e376bd84c4b",
  "outputs": {
    "aurora": {
      "value": {
        "ClusterName": "commons-aurora-stack-dbcluster-1aou11us00k9b",
        "DNSName": "commons-aurora-stack-dbcluster-1aou11us00k9b.cluster-ckjbjchdztcg.us-east-1.rds.amazonaws.com",
        "SecurityGroupId": "sg-017c32fa799279858",
        "StackName": "commons-aurora-stack",
        "TemplateID": "state/rds-aurora-serverless-postgres",
        "TemplateVersion": "13.4.0"
      },
      "type": [
        "map",
        "string"
      ]
    },
    "cluster": {
      "value": {
        "CanonicalHostedZoneID": "Z35SXDOTRQ7X7K",
        "Cluster": "commons-cluster",
        "DNSName": "commo-LoadB-1Y0S5TB31IQ0D-1561513888.us-east-1.elb.amazonaws.com",
        "HttpListener": "arn:aws:elasticloadbalancing:us-east-1:246369665268:listener/app/commo-LoadB-1Y0S5TB31IQ0D/81894e35a34b3a62/7cf07933c25f27f4",
        "LoadBalancerFullName": "app/commo-LoadB-1Y0S5TB31IQ0D/81894e35a34b3a62",
        "LoadBalancerSecurityGroup": "sg-079ddc9e61328d931",
        "StackName": "commons-cluster-stack",
        "TemplateID": "fargate/cluster",
        "TemplateVersion": "__VERSION__",
        "URL": "http://commo-LoadB-1Y0S5TB31IQ0D-1561513888.us-east-1.elb.amazonaws.com"
      },
      "type": [
        "map",
        "string"
      ]
    },
    "ec2": {
      "value": {
        "InstanceId": "i-05b3e6c0fd47fb909",
        "PrivateIPAddress": "10.0.13.115",
        "PublicIPAddress": "54.84.12.236",
        "StackName": "commons-ec2-stack",
        "TemplateID": "ec2/al2-mutable-public",
        "TemplateVersion": "__VERSION__"
      },
      "type": [
        "map",
        "string"
      ]
    }
  },
  "resources": [
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "aurora_postgres",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-aurora-stack/156eefd0-7018-11eb-82fd-0ad252bd0169",
            "name": "commons-aurora-stack",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "ClusterName": "commons-aurora-stack-dbcluster-1aou11us00k9b",
              "DNSName": "commons-aurora-stack-dbcluster-1aou11us00k9b.cluster-ckjbjchdztcg.us-east-1.rds.amazonaws.com",
              "SecurityGroupId": "sg-017c32fa799279858",
              "StackName": "commons-aurora-stack",
              "TemplateID": "state/rds-aurora-serverless-postgres",
              "TemplateVersion": "13.4.0"
            },
            "parameters": {
              "DBMasterUserPassword": "****",
              "DBMasterUsername": "commons",
              "DBName": "commons",
              "EnableDataApi": "true",
              "ParentClientStack": "commons-client-sg-stack",
              "ParentKmsKeyStack": "commons-kms-stack-final",
              "ParentVPCStack": "commons-vpc-stack"
            },
            "policy_body": null,
            "policy_url": null,
            "tags": {},
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'State: RDS Aurora Serverless PostgreSQL, a cloudonaut.io template'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'Parent Stacks'\n        Parameters:\n          - ParentVPCStack\n          - ParentClientStack\n          - ParentKmsKeyStack\n          - ParentZoneStack\n          - ParentSSHBastionStack\n          - ParentAlertStack\n      - Label:\n          default: 'RDS Parameters'\n        Parameters:\n          - EngineVersion\n          - DBSnapshotIdentifier\n          - DBName\n          - DBBackupRetentionPeriod\n          - DBMasterUsername\n          - DBMasterUserPassword\n          - SubDomainNameWithDot\n          - PreferredBackupWindow\n          - PreferredMaintenanceWindow\n          - EnableDataApi\n      - Label:\n          default: 'Serverless Parameters'\n        Parameters:\n          - AutoPause\n          - MaxCapacity\n          - MinCapacity\n          - SecondsUntilAutoPause\nParameters:\n  ParentVPCStack:\n    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'\n    Type: String\n  ParentClientStack:\n    Description: 'Stack name of parent client stack based on state/client-sg.yaml template.'\n    Type: String\n  ParentKmsKeyStack:\n    Description: 'Stack name of parent KMS key stack based on security/kms-key.yaml template (ignored when DBSnapshotIdentifier is set, value used from snapshot).'\n    Type: String\n    Default: ''\n  ParentZoneStack:\n    Description: 'Optional stack name of parent zone stack based on vpc/vpc-zone-*.yaml template.'\n    Type: String\n    Default: ''\n  ParentSSHBastionStack:\n    Description: 'Optional but recommended stack name of parent SSH bastion host/instance stack based on vpc/vpc-*-bastion.yaml template.'\n    Type: String\n    Default: ''\n  ParentAlertStack:\n    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'\n    Type: String\n    Default: ''\n  DBSnapshotIdentifier:\n    Description: 'Optional identifier for the DB cluster snapshot from which you want to restore (leave blank to create an empty cluster).'\n    Type: String\n    Default: ''\n  DBName:\n    Description: 'Name of the database (ignored when DBSnapshotIdentifier is set, value used from snapshot).'\n    Type: String\n    Default: ''\n  DBBackupRetentionPeriod:\n    Description: 'The number of days to keep snapshots of the cluster.'\n    Type: Number\n    MinValue: 1\n    MaxValue: 35\n    Default: 30\n  DBMasterUsername:\n    Description: 'The master user name for the DB instance (ignored when DBSnapshotIdentifier is set, value used from snapshot).'\n    Type: 'String'\n    Default: master\n  DBMasterUserPassword:\n    Description: 'The master password for the DB instance (ignored when DBSnapshotIdentifier is set, value used from snapshot).'\n    Type: String\n    NoEcho: true\n    Default: ''\n  SubDomainNameWithDot:\n    Description: 'Name that is used to create the DNS entry with trailing dot, e.g. ?{SubDomainNameWithDot}?{HostedZoneName}. Leave blank for naked (or apex and bare) domain. Requires ParentZoneStack parameter!'\n    Type: String\n    Default: 'aurora.'\n  PreferredBackupWindow:\n    Description: 'IGNORED BECAUSE OF A BUG IN CLOUDFORMATION! VALUE WILL APPLY IN THE FUTURE! The daily time range in UTC during which you want to create automated backups.' # TODO remove uppercase warning\n    Type: String\n    Default: '09:54-10:24'\n  PreferredMaintenanceWindow:\n    Description: 'IGNORED BECAUSE OF A BUG IN CLOUDFORMATION! VALUE WILL APPLY IN THE FUTURE! The weekly time range (in UTC) during which system maintenance can occur.' # TODO remove uppercase warning\n    Type: String\n    Default: 'sat:07:00-sat:07:30'\n  EnableDataApi:\n    Description: 'Enable the Data API (https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/data-api.html).'\n    Type: String\n    AllowedValues: ['true', 'false']\n    Default: 'false'\n  AutoPause:\n    Description: 'Enable automatic pause for a Serverless Aurora cluster. A cluster can be paused only when it has no connections. If a cluster is paused for more than seven days, the cluster might be backed up with a snapshot. In this case, the cluster is restored when there is a request to connect to it.'\n    Type: String\n    AllowedValues: ['true', 'false']\n    Default: 'true'\n  MaxCapacity:\n    Description: 'The maximum capacity units for a Serverless Aurora cluster.'\n    Type: String\n    AllowedValues: [2, 4, 8, 16, 32, 64, 192, 384]\n    Default: 2\n  MinCapacity:\n    Description: 'The minimum capacity units for a Serverless Aurora cluster.'\n    Type: String\n    AllowedValues: [2, 4, 8, 16, 32, 64, 192, 384]\n    Default: 2\n  SecondsUntilAutoPause:\n    Description: 'The time, in seconds, before a Serverless Aurora cluster is paused.'\n    Type: Number\n    MinValue: 1\n    MaxValue: 86400\n    Default: 300\n  EngineVersion:\n    Description: 'Aurora Serverless PostgreSQL version.'\n    Type: String\n    Default: '10.7'\n    AllowedValues: ['10.7', '12.4'] # aws rds describe-db-engine-versions --engine aurora-postgresql --query 'DBEngineVersions[?contains(SupportedEngineModes,`serverless`)]'\nMappings:\n  EngineVersionMap:\n    '10.7':\n      ClusterParameterGroupFamily: 'aurora-postgresql10'\n    '12.4':\n      ClusterParameterGroupFamily: 'aurora-postgresql12'\nConditions:\n  HasZone: !Not [!Equals [!Ref ParentZoneStack, '']]\n  HasSSHBastionSecurityGroup: !Not [!Equals [!Ref ParentSSHBastionStack, '']]\n  HasAlertTopic: !Not [!Equals [!Ref ParentAlertStack, '']]\n  HasNotDBSnapshotIdentifier: !Equals [!Ref DBSnapshotIdentifier, '']\n  HasDBSnapshotIdentifier: !Not [!Condition HasNotDBSnapshotIdentifier]\nResources:\n  RecordSet:\n    Condition: HasZone\n    Type: 'AWS::Route53::RecordSet'\n    Properties:\n      HostedZoneId:\n        { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneId' }\n      Name: !Sub\n        - '${SubDomainNameWithDot}${HostedZoneName}'\n        - SubDomainNameWithDot: !Ref SubDomainNameWithDot\n          HostedZoneName:\n            { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneName' }\n      ResourceRecords:\n        - !GetAtt 'DBCluster.Endpoint.Address'\n      TTL: 60\n      Type: CNAME\n  ClusterSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: !Ref 'AWS::StackName'\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 5432\n          ToPort: 5432\n          SourceSecurityGroupId:\n            {\n              'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'\n            }\n      VpcId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC' }\n  ClusterSecurityGroupInSSHBastion:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasSSHBastionSecurityGroup\n    Properties:\n      GroupId: !Ref ClusterSecurityGroup\n      IpProtocol: tcp\n      FromPort: 5432\n      ToPort: 5432\n      SourceSecurityGroupId:\n        { 'Fn::ImportValue': !Sub '${ParentSSHBastionStack}-SecurityGroup' }\n  DBSubnetGroup:\n    Type: 'AWS::RDS::DBSubnetGroup'\n    Properties:\n      DBSubnetGroupDescription: !Ref 'AWS::StackName'\n      SubnetIds:\n        !Split [\n          ',',\n          { 'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetsPrivate' }\n        ]\n  DBClusterParameterGroup:\n    Type: 'AWS::RDS::DBClusterParameterGroup'\n    Properties:\n      Description: !Ref 'AWS::StackName'\n      Family:\n        !FindInMap [\n          EngineVersionMap,\n          !Ref EngineVersion,\n          ClusterParameterGroupFamily\n        ]\n      Parameters:\n        client_encoding: 'UTF8'\n  DBCluster:\n    DeletionPolicy: Snapshot # default\n    UpdateReplacePolicy: Snapshot\n    Type: 'AWS::RDS::DBCluster'\n    Properties:\n      BackupRetentionPeriod: !Ref DBBackupRetentionPeriod\n      DatabaseName:\n        !If [HasDBSnapshotIdentifier, !Ref 'AWS::NoValue', !Ref DBName]\n      DBClusterParameterGroupName: !Ref DBClusterParameterGroup\n      DBSubnetGroupName: !Ref DBSubnetGroup\n      EnableHttpEndpoint: !Ref EnableDataApi\n      Engine: aurora-postgresql\n      EngineMode: serverless\n      EngineVersion: !Ref EngineVersion\n      KmsKeyId:\n        !If [\n          HasDBSnapshotIdentifier,\n          !Ref 'AWS::NoValue',\n          { 'Fn::ImportValue': !Sub '${ParentKmsKeyStack}-KeyArn' }\n        ]\n      MasterUsername:\n        !If [\n          HasDBSnapshotIdentifier,\n          !Ref 'AWS::NoValue',\n          !Ref DBMasterUsername\n        ]\n      MasterUserPassword:\n        !If [\n          HasDBSnapshotIdentifier,\n          !Ref 'AWS::NoValue',\n          !Ref DBMasterUserPassword\n        ]\n      # PreferredBackupWindow: !Ref PreferredBackupWindow TODO re-enable as soon as CloudFormation bug ix fixed\n      # PreferredMaintenanceWindow: !Ref PreferredMaintenanceWindow TODO re-enable as soon as CloudFormation bug ix fixed\n      ScalingConfiguration:\n        AutoPause: !Ref AutoPause\n        MaxCapacity: !Ref MaxCapacity\n        MinCapacity: !Ref MinCapacity\n        SecondsUntilAutoPause: !Ref SecondsUntilAutoPause\n      SnapshotIdentifier:\n        !If [\n          HasDBSnapshotIdentifier,\n          !Ref DBSnapshotIdentifier,\n          !Ref 'AWS::NoValue'\n        ]\n      StorageEncrypted: true\n      VpcSecurityGroupIds:\n        - !Ref ClusterSecurityGroup\n  DatabaseClusterEventSubscription:\n    Condition: HasAlertTopic\n    Type: 'AWS::RDS::EventSubscription'\n    Properties:\n      EventCategories:\n        - failover\n        - failure\n        - maintenance\n      SnsTopicArn: { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      SourceIds: [!Ref DBCluster]\n      SourceType: 'db-cluster'\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'state/rds-aurora-serverless-postgres'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '13.4.0'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n  ClusterName:\n    Description: 'The name of the cluster.'\n    Value: !Ref DBCluster\n    Export:\n      Name: !Sub '${AWS::StackName}-ClusterName'\n  DNSName:\n    Description: 'The connection endpoint for the DB cluster.'\n    Value: !GetAtt 'DBCluster.Endpoint.Address'\n    Export:\n      Name: !Sub '${AWS::StackName}-DNSName'\n  SecurityGroupId:\n    Description: 'The security group used to manage access to RDS Aurora Serverless Postgres.'\n    Value: !Ref ClusterSecurityGroup\n    Export:\n      Name: !Sub '${AWS::StackName}-SecurityGroupId'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "aws_cloudformation_stack.client_sg",
            "aws_cloudformation_stack.vpc"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "client_sg",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-client-sg-stack/0c160db0-7018-11eb-92ad-0ae28d89ba2b",
            "name": "commons-client-sg-stack",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "ClientSecurityGroup": "sg-01c32e1c7a82c3e81",
              "StackName": "commons-client-sg-stack",
              "TemplateID": "state/client-sg",
              "TemplateVersion": "__VERSION__"
            },
            "parameters": {
              "ParentVPCStack": "commons-vpc-stack"
            },
            "policy_body": null,
            "policy_url": null,
            "tags": {},
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'State: Client security group, a cloudonaut.io template, sponsored by https://github.com/ngault'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'Parent Stacks'\n        Parameters:\n          - ParentVPCStack\nParameters:\n  ParentVPCStack:\n    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'\n    Type: String\nResources:\n  ClientSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: !Ref 'AWS::StackName'\n      VpcId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC' }\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'state/client-sg'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '__VERSION__'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n  ClientSecurityGroup:\n    Description: 'Use this Security Group to reference client traffic.'\n    Value: !Ref ClientSecurityGroup\n    Export:\n      Name: !Sub '${AWS::StackName}-ClientSecurityGroup'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "aws_cloudformation_stack.vpc"
          ],
          "create_before_destroy": true
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "ec2_tunnel",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-ec2-stack/ab45b280-7358-11eb-b257-0afb3fae16e5",
            "name": "commons-ec2-stack",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "InstanceId": "i-05b3e6c0fd47fb909",
              "PrivateIPAddress": "10.0.13.115",
              "PublicIPAddress": "54.84.12.236",
              "StackName": "commons-ec2-stack",
              "TemplateID": "ec2/al2-mutable-public",
              "TemplateVersion": "__VERSION__"
            },
            "parameters": {
              "KeyName": "ssh-key",
              "ParentVPCStack": "commons-vpc-stack"
            },
            "policy_body": null,
            "policy_url": null,
            "tags": null,
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'EC2: Amazon Linux 2 (mutable, public), a cloudonaut.io template'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'Parent Stacks'\n        Parameters:\n          - ParentVPCStack\n          - ParentSSHBastionStack\n          - ParentAlertStack\n          - ParentKmsKeyStack\n          - ParentZoneStack\n          - ParentClientStack1\n          - ParentClientStack2\n          - ParentClientStack3\n      - Label:\n          default: 'Network Parameters'\n        Parameters:\n          - SubnetName\n          - SubDomainNameWithDot\n          - IngressTcpPort1\n          - IngressTcpParentClientStack1\n          - IngressTcpPort2\n          - IngressTcpParentClientStack2\n          - IngressTcpPort3\n          - IngressTcpParentClientStack3\n      - Label:\n          default: 'Permission Parameters'\n        Parameters:\n          - KeyName\n          - IAMUserSSHAccess\n          - ManagedPolicyArns\n          - PermissionsBoundary\n      - Label:\n          default: 'EC2 Parameters'\n        Parameters:\n          - Name\n          - AmazonLinux2Version\n          - RestoreImageId\n          - InstanceType\n          - UserData\n          - RootVolumeSize\n      - Label:\n          default: 'Operational Parameters'\n        Parameters:\n          - LogsRetentionInDays\n          - MaintenanceWindowSchedule\n          - MaintenanceWindowScheduleTimezone\n          - BackupRetentionPeriod\n          - BackupScheduleExpression\nParameters:\n  ParentVPCStack:\n    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'\n    Type: String\n  ParentSSHBastionStack:\n    Description: 'Optional but recommended stack name of parent SSH bastion host/instance stack based on vpc/vpc-*-bastion.yaml template.'\n    Type: String\n    Default: ''\n  ParentAlertStack:\n    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'\n    Type: String\n    Default: ''\n  ParentKmsKeyStack:\n    Description: 'Optional stack name of parent KMS key stack based on security/kms-key.yaml template.'\n    Type: String\n    Default: ''\n  ParentZoneStack:\n    Description: 'Optional stack name of parent zone stack based on vpc/zone-*.yaml template.'\n    Type: String\n    Default: ''\n  ParentClientStack1:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the EC2 instance to whatever uses the client security group.'\n    Type: String\n    Default: ''\n  ParentClientStack2:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the EC2 instance to whatever uses the client security group.'\n    Type: String\n    Default: ''\n  ParentClientStack3:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the EC2 instance to whatever uses the client security group.'\n    Type: String\n    Default: ''\n  KeyName:\n    Description: 'Optional key pair of the ec2-user to establish a SSH connection to the EC2 instance.'\n    Type: String\n    Default: ''\n  IAMUserSSHAccess:\n    Description: 'Synchronize public keys of IAM users to enable personalized SSH access (Doc: https://cloudonaut.io/manage-aws-ec2-ssh-access-with-iam/).'\n    Type: String\n    Default: false\n    AllowedValues:\n      - true\n      - false\n  InstanceType:\n    Description: 'The instance type for the EC2 instance.'\n    Type: String\n    Default: 't3.nano'\n  Name:\n    Description: 'The name for the EC2 instance.'\n    Type: String\n    Default: 'test'\n  SubnetName:\n    Description: 'Subnet name of parent VPC stack based on vpc/vpc-*azs.yaml template.'\n    Type: String\n    Default: SubnetAPublic\n    AllowedValues:\n      - SubnetAPublic\n      - SubnetBPublic\n      - SubnetCPublic\n      - SubnetDPublic\n  LogsRetentionInDays:\n    Description: 'Specifies the number of days you want to retain log events.'\n    Type: Number\n    Default: 14\n    AllowedValues:\n      [\n        1,\n        3,\n        5,\n        7,\n        14,\n        30,\n        60,\n        90,\n        120,\n        150,\n        180,\n        365,\n        400,\n        545,\n        731,\n        1827,\n        3653\n      ]\n  SubDomainNameWithDot:\n    Description: 'Name that is used to create the DNS entry with trailing dot, e.g. ?{SubDomainNameWithDot}?{HostedZoneName}. Leave blank for naked (or apex and bare) domain. Requires ParentZoneStack parameter!'\n    Type: String\n    Default: ''\n  UserData:\n    Description: 'Optional Bash script executed on first instance launch.'\n    Type: String\n    Default: ''\n  IngressTcpPort1:\n    Description: 'Optional port allowing ingress TCP traffic.'\n    Type: String\n    Default: ''\n  IngressTcpParentClientStack1:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml that is required to access IngressTcpPort1 (if you leave this blank, IngressTcpPort1 is open to the world 0.0.0.0/0).'\n    Type: String\n    Default: ''\n  IngressTcpPort2:\n    Description: 'Optional port allowing ingress TCP traffic.'\n    Type: String\n    Default: ''\n  IngressTcpParentClientStack2:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml that is required to access IngressTcpPort2 (if you leave this blank, IngressTcpPort2 is open to the world 0.0.0.0/0).'\n    Type: String\n    Default: ''\n  IngressTcpPort3:\n    Description: 'Optional port allowing ingress TCP traffic.'\n    Type: String\n    Default: ''\n  IngressTcpParentClientStack3:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml that is required to access IngressTcpPort3 (if you leave this blank, IngressTcpPort3 is open to the world 0.0.0.0/0).'\n    Type: String\n    Default: ''\n  ManagedPolicyArns:\n    Description: \"Optional comma-delimited list of IAM managed policy ARNs to attach to the instance's IAM role.\"\n    Type: String\n    Default: ''\n  PermissionsBoundary:\n    Description: 'Optional ARN for a policy that will be used as the permission boundary for all roles created by this template.'\n    Type: String\n    Default: ''\n  RootVolumeSize:\n    Description: 'The root volume size, in Gibibytes (GiB) (if RestoreImageId is set, value must be \u003e= snapshot of AMI).'\n    Type: Number\n    Default: 8\n    ConstraintDescription: 'Must be in the range [8-1024]'\n    MinValue: 8\n    MaxValue: 1024\n  MaintenanceWindowSchedule:\n    Description: 'SSM cron expressions to trigger the maintenace window for patch installation.'\n    Type: String\n    Default: 'cron(0 5 ? * SUN *)'\n  MaintenanceWindowScheduleTimezone:\n    Description: 'Timezone for maintenance window schedule (in IANA format).'\n    Type: String\n    Default: UTC\n  BackupRetentionPeriod:\n    Description: 'The number of days to keep backups of the EC2 instance (set to 0 to disable).'\n    Type: Number\n    MinValue: 0\n    MaxValue: 35\n    Default: 30\n  BackupScheduleExpression:\n    Description: 'A CRON expression specifying when AWS Backup initiates a backup job.'\n    Type: String\n    Default: 'cron(0 4 ? * * *)'\n  RestoreImageId:\n    Description: 'Restore from existing Amazon Machine Image (AMI).'\n    Type: String\n    Default: ''\n  AmazonLinux2Version:\n    Description: 'Version of Amazon Linux 2 to boot from the first time (ignored if RestoreImageId is set; select the latest version for new stacks; OS updates are enabled to patch the system).'\n    Type: String\n    Default: '20191217.0'\n    AllowedValues:\n      [\n        '20210126.0',\n        '20200917.0',\n        '20200722.0',\n        '20200520.1',\n        '20200406.0',\n        '20200304.0',\n        '20200207.1',\n        '20191217.0'\n      ]\nMappings:\n  VersionMap:\n    '20210126.0':\n      Map: RegionMap202101260\n    '20200917.0':\n      Map: RegionMap20200917\n    '20200722.0':\n      Map: RegionMap202007220\n    '20200520.1':\n      Map: RegionMap202005201\n    '20200406.0':\n      Map: RegionMap202004060\n    '20200304.0':\n      Map: RegionMap202003040\n    '20200207.1':\n      Map: RegionMap202002071\n    '20191217.0':\n      Map: RegionMap201912170\n  RegionMap202101260:\n    'af-south-1':\n      AMI: 'ami-0438616cef15ba2ca'\n    'eu-north-1':\n      AMI: 'ami-0eb6f319b31f7092d'\n    'ap-south-1':\n      AMI: 'ami-08e0ca9924195beba'\n    'eu-west-3':\n      AMI: 'ami-0ea4a063871686f37'\n    'eu-west-2':\n      AMI: 'ami-098828924dc89ea4a'\n    'eu-south-1':\n      AMI: 'ami-0ea288dd7bb5b0251'\n    'eu-west-1':\n      AMI: 'ami-0fc970315c2d38f01'\n    'ap-northeast-2':\n      AMI: 'ami-09282971cf2faa4c9'\n    'me-south-1':\n      AMI: 'ami-0cc4f2b06b56d27e9'\n    'ap-northeast-1':\n      AMI: 'ami-0992fc94ca0f1415a'\n    'sa-east-1':\n      AMI: 'ami-089aac6323aa08aee'\n    'ca-central-1':\n      AMI: 'ami-075cfad2d9805c5f2'\n    'ap-east-1':\n      AMI: 'ami-040f64b9a031d8eb0'\n    'ap-southeast-1':\n      AMI: 'ami-0e2e44c03b85f58b3'\n    'ap-southeast-2':\n      AMI: 'ami-04f77aa5970939148'\n    'eu-central-1':\n      AMI: 'ami-0a6dc7529cd559185'\n    'us-east-1':\n      AMI: 'ami-047a51fa27710816e'\n    'us-east-2':\n      AMI: 'ami-01aab85a5e4a5a0fe'\n    'us-west-1':\n      AMI: 'ami-005c06c6de69aee84'\n    'us-west-2':\n      AMI: 'ami-0e999cbd62129e3b1'\n  RegionMap20200917:\n    'af-south-1':\n      AMI: 'ami-0cec12e29ebe3f0d5'\n    'eu-north-1':\n      AMI: 'ami-0653812935d0743fe'\n    'ap-south-1':\n      AMI: 'ami-0e306788ff2473ccb'\n    'eu-west-3':\n      AMI: 'ami-0de12f76efe134f2f'\n    'eu-west-2':\n      AMI: 'ami-0a669382ea0feb73a'\n    'eu-south-1':\n      AMI: 'ami-0759301b88845d121'\n    'eu-west-1':\n      AMI: 'ami-0bb3fad3c0286ebd5'\n    'ap-northeast-2':\n      AMI: 'ami-03b42693dc6a7dc35'\n    'me-south-1':\n      AMI: 'ami-08155c9ee8b845e35'\n    'ap-northeast-1':\n      AMI: 'ami-0ce107ae7af2e92b5'\n    'sa-east-1':\n      AMI: 'ami-02898a1921d38a50b'\n    'ca-central-1':\n      AMI: 'ami-0c2f25c1f66a1ff4d'\n    'ap-east-1':\n      AMI: 'ami-814d0ff0'\n    'ap-southeast-1':\n      AMI: 'ami-015a6758451df3cb9'\n    'ap-southeast-2':\n      AMI: 'ami-0f96495a064477ffb'\n    'eu-central-1':\n      AMI: 'ami-00a205cb8e06c3c4e'\n    'us-east-1':\n      AMI: 'ami-0947d2ba12ee1ff75'\n    'us-east-2':\n      AMI: 'ami-03657b56516ab7912'\n    'us-west-1':\n      AMI: 'ami-0e4035ae3f70c400f'\n    'us-west-2':\n      AMI: 'ami-0528a5175983e7f28'\n  RegionMap202007220:\n    'af-south-1':\n      AMI: 'ami-08c9d9528020000ac'\n    'eu-north-1':\n      AMI: 'ami-039609244d2810a6b'\n    'ap-south-1':\n      AMI: 'ami-0ebc1ac48dfd14136'\n    'eu-west-3':\n      AMI: 'ami-093fa4c538885becf'\n    'eu-west-2':\n      AMI: 'ami-0a13d44dccf1f5cf6'\n    'eu-south-1':\n      AMI: 'ami-0533a9871112d2d51'\n    'eu-west-1':\n      AMI: 'ami-07d9160fa81ccffb5'\n    'ap-northeast-2':\n      AMI: 'ami-0bd7691bf6470fe9c'\n    'me-south-1':\n      AMI: 'ami-01f41d49c363da2ad'\n    'ap-northeast-1':\n      AMI: 'ami-0cc75a8978fbbc969'\n    'sa-east-1':\n      AMI: 'ami-018ccfb6b4745882a'\n    'ca-central-1':\n      AMI: 'ami-013d1df4bcea6ba95'\n    'ap-east-1':\n      AMI: 'ami-47317236'\n    'ap-southeast-1':\n      AMI: 'ami-0cd31be676780afa7'\n    'ap-southeast-2':\n      AMI: 'ami-0ded330691a314693'\n    'eu-central-1':\n      AMI: 'ami-0c115dbd34c69a004'\n    'us-east-1':\n      AMI: 'ami-02354e95b39ca8dec'\n    'us-east-2':\n      AMI: 'ami-07c8bc5c1ce9598c3'\n    'us-west-1':\n      AMI: 'ami-05655c267c89566dd'\n    'us-west-2':\n      AMI: 'ami-0873b46c45c11058d'\n  RegionMap202005201:\n    'af-south-1':\n      AMI: 'ami-0ec47ddb564d75b64'\n    'eu-north-1':\n      AMI: 'ami-04697c9bb5d6135a2'\n    'ap-south-1':\n      AMI: 'ami-0447a12f28fddb066'\n    'eu-west-3':\n      AMI: 'ami-01c72e187b357583b'\n    'eu-west-2':\n      AMI: 'ami-032598fcc7e9d1c7a'\n    'eu-south-1':\n      AMI: 'ami-0f9b9a8cf93d838d0'\n    'eu-west-1':\n      AMI: 'ami-0ea3405d2d2522162'\n    'ap-northeast-2':\n      AMI: 'ami-01af223aa7f274198'\n    'me-south-1':\n      AMI: 'ami-01b31491b74045c0c'\n    'ap-northeast-1':\n      AMI: 'ami-0a1c2ec61571737db'\n    'sa-east-1':\n      AMI: 'ami-0477a95397a9154b3'\n    'ca-central-1':\n      AMI: 'ami-0f75c2980c6a5851d'\n    'ap-east-1':\n      AMI: 'ami-49bbfa38'\n    'ap-southeast-1':\n      AMI: 'ami-0615132a0f36d24f4'\n    'ap-southeast-2':\n      AMI: 'ami-088ff0e3bde7b3fdf'\n    'eu-central-1':\n      AMI: 'ami-0a02ee601d742e89f'\n    'us-east-1':\n      AMI: 'ami-09d95fab7fff3776c'\n    'us-east-2':\n      AMI: 'ami-026dea5602e368e96'\n    'us-west-1':\n      AMI: 'ami-04e59c05167ea7bd5'\n    'us-west-2':\n      AMI: 'ami-0e34e7b9ca0ace12d'\n  RegionMap202004060:\n    'af-south-1':\n      AMI: 'ami-0b4a93eff849f20ca'\n    'eu-north-1':\n      AMI: 'ami-0b7a46b4bd694e8a6'\n    'ap-south-1':\n      AMI: 'ami-0470e33cd681b2476'\n    'eu-west-3':\n      AMI: 'ami-00077e3fed5089981'\n    'eu-west-2':\n      AMI: 'ami-01a6e31ac994bbc09'\n    'eu-south-1':\n      AMI: 'ami-06db5ba0a09e927c8'\n    'eu-west-1':\n      AMI: 'ami-06ce3edf0cff21f07'\n    'ap-northeast-2':\n      AMI: 'ami-01288945bd24ed49a'\n    'me-south-1':\n      AMI: 'ami-0fde637e0db57a2ab'\n    'ap-northeast-1':\n      AMI: 'ami-0f310fced6141e627'\n    'sa-east-1':\n      AMI: 'ami-003449ffb2605a74c'\n    'ca-central-1':\n      AMI: 'ami-054362537f5132ce2'\n    'ap-east-1':\n      AMI: 'ami-dd7731ac'\n    'ap-southeast-1':\n      AMI: 'ami-0ec225b5e01ccb706'\n    'ap-southeast-2':\n      AMI: 'ami-0970010f37c4f9c8d'\n    'eu-central-1':\n      AMI: 'ami-076431be05aaf8080'\n    'us-east-1':\n      AMI: 'ami-0323c3dd2da7fb37d'\n    'us-east-2':\n      AMI: 'ami-0f7919c33c90f5b58'\n    'us-west-1':\n      AMI: 'ami-06fcc1f0bc2c8943f'\n    'us-west-2':\n      AMI: 'ami-0d6621c01e8c2de2c'\n  RegionMap202003040:\n    'eu-north-1':\n      AMI: 'ami-0f630db6194a81ad0'\n    'ap-south-1':\n      AMI: 'ami-03b5297d565ef30a6'\n    'eu-west-3':\n      AMI: 'ami-07eda9385feb1e969'\n    'eu-west-2':\n      AMI: 'ami-0cb790308f7591fa6'\n    'eu-west-1':\n      AMI: 'ami-04d5cc9b88f9d1d39'\n    'ap-northeast-2':\n      AMI: 'ami-0db78afd3d150fc18'\n    'me-south-1':\n      AMI: 'ami-05613911cb72781b8'\n    'ap-northeast-1':\n      AMI: 'ami-052652af12b58691f'\n    'sa-east-1':\n      AMI: 'ami-0b032e878a66c3b68'\n    'ca-central-1':\n      AMI: 'ami-0bf54ac1b628cf143'\n    'ap-east-1':\n      AMI: 'ami-33a7e042'\n    'ap-southeast-1':\n      AMI: 'ami-0cbc6aae997c6538a'\n    'ap-southeast-2':\n      AMI: 'ami-08fdde86b93accf1c'\n    'eu-central-1':\n      AMI: 'ami-0ec1ba09723e5bfac'\n    'us-east-1':\n      AMI: 'ami-0fc61db8544a617ed'\n    'us-east-2':\n      AMI: 'ami-0e01ce4ee18447327'\n    'us-west-1':\n      AMI: 'ami-09a7fe78668f1e2c0'\n    'us-west-2':\n      AMI: 'ami-0ce21b51cb31a48b8'\n  RegionMap202002071:\n    'eu-north-1':\n      AMI: 'ami-074a0e4318181e9d9'\n    'ap-south-1':\n      AMI: 'ami-0d9462a653c34dab7'\n    'eu-west-3':\n      AMI: 'ami-0fd9bce3a3384b635'\n    'eu-west-2':\n      AMI: 'ami-0389b2a3c4948b1a0'\n    'eu-west-1':\n      AMI: 'ami-099a8245f5daa82bf'\n    'ap-northeast-2':\n      AMI: 'ami-0a93a08544874b3b7'\n    'me-south-1':\n      AMI: 'ami-0e0e68bcf15b6f5cd'\n    'ap-northeast-1':\n      AMI: 'ami-0af1df87db7b650f4'\n    'sa-east-1':\n      AMI: 'ami-080a223be3de0c3b8'\n    'ca-central-1':\n      AMI: 'ami-00db12b46ef5ebc36'\n    'ap-east-1':\n      AMI: 'ami-47e4a036'\n    'ap-southeast-1':\n      AMI: 'ami-0f02b24005e4aec36'\n    'ap-southeast-2':\n      AMI: 'ami-0f767afb799f45102'\n    'eu-central-1':\n      AMI: 'ami-0df0e7600ad0913a9'\n    'us-east-1':\n      AMI: 'ami-0a887e401f7654935'\n    'us-east-2':\n      AMI: 'ami-0e38b48473ea57778'\n    'us-west-1':\n      AMI: 'ami-01c94064639c71719'\n    'us-west-2':\n      AMI: 'ami-0e8c04af2729ff1bb'\n  RegionMap201912170:\n    'eu-north-1':\n      AMI: 'ami-0662eb9b9b8685935'\n    'ap-south-1':\n      AMI: 'ami-0217a85e28e625474'\n    'eu-west-3':\n      AMI: 'ami-007fae589fdf6e955'\n    'eu-west-2':\n      AMI: 'ami-0089b31e09ac3fffc'\n    'eu-west-1':\n      AMI: 'ami-0713f98de93617bb4'\n    'ap-northeast-2':\n      AMI: 'ami-0bea7fd38fabe821a'\n    'me-south-1':\n      AMI: 'ami-05f93aaf03b9bf20c'\n    'ap-northeast-1':\n      AMI: 'ami-011facbea5ec0363b'\n    'sa-east-1':\n      AMI: 'ami-09de7b4017733e2af'\n    'ca-central-1':\n      AMI: 'ami-0a269ca7cc3e3beff'\n    'ap-east-1':\n      AMI: 'ami-db3d78aa'\n    'ap-southeast-1':\n      AMI: 'ami-05c64f7b4062b0a21'\n    'ap-southeast-2':\n      AMI: 'ami-0b8b10b5bf11f3a22'\n    'eu-central-1':\n      AMI: 'ami-07cda0db070313c52'\n    'us-east-1':\n      AMI: 'ami-062f7200baf2fa504'\n    'us-east-2':\n      AMI: 'ami-02ccb28830b645a41'\n    'us-west-1':\n      AMI: 'ami-03caa3f860895f82e'\n    'us-west-2':\n      AMI: 'ami-04590e7389a6e577c'\nConditions:\n  HasPermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundary, '']]\n  HasKmsKey: !Not [!Equals [!Ref ParentKmsKeyStack, '']]\n  HasKeyName: !Not [!Equals [!Ref KeyName, '']]\n  HasIAMUserSSHAccess: !Equals [!Ref IAMUserSSHAccess, 'true']\n  HasSSHBastionSecurityGroup: !Not [!Equals [!Ref ParentSSHBastionStack, '']]\n  HasNotSSHBastionSecurityGroup: !Equals [!Ref ParentSSHBastionStack, '']\n  HasAlertTopic: !Not [!Equals [!Ref ParentAlertStack, '']]\n  HasZone: !Not [!Equals [!Ref ParentZoneStack, '']]\n  HasIngressTcpPort1: !Not [!Equals [!Ref IngressTcpPort1, '']]\n  HasIngressTcpParentClientStack1:\n    !Not [!Equals [!Ref IngressTcpParentClientStack1, '']]\n  HasIngressTcpPort2: !Not [!Equals [!Ref IngressTcpPort2, '']]\n  HasIngressTcpParentClientStack2:\n    !Not [!Equals [!Ref IngressTcpParentClientStack2, '']]\n  HasIngressTcpPort3: !Not [!Equals [!Ref IngressTcpPort3, '']]\n  HasIngressTcpParentClientStack3:\n    !Not [!Equals [!Ref IngressTcpParentClientStack3, '']]\n  HasClientSecurityGroup1: !Not [!Equals [!Ref ParentClientStack1, '']]\n  HasClientSecurityGroup2: !Not [!Equals [!Ref ParentClientStack2, '']]\n  HasClientSecurityGroup3: !Not [!Equals [!Ref ParentClientStack3, '']]\n  HasManagedPolicyArns: !Not [!Equals [!Ref ManagedPolicyArns, '']]\n  HasBackupRetentionPeriod: !Not [!Equals [!Ref BackupRetentionPeriod, 0]]\n  HasRestoreImageId: !Not [!Equals [!Ref RestoreImageId, '']]\nResources:\n  RecordSet:\n    Condition: HasZone\n    Type: 'AWS::Route53::RecordSet'\n    Properties:\n      HostedZoneId:\n        { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneId' }\n      Name: !Sub\n        - '${SubDomainNameWithDot}${HostedZoneName}'\n        - SubDomainNameWithDot: !Ref SubDomainNameWithDot\n          HostedZoneName:\n            { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneName' }\n      ResourceRecords:\n        - !Ref ElasticIP\n      TTL: 60\n      Type: A\n  ElasticIP:\n    Type: 'AWS::EC2::EIP'\n    Properties:\n      Domain: vpc\n  NetworkInterface:\n    Type: 'AWS::EC2::NetworkInterface'\n    Properties:\n      GroupSet:\n        - !Ref SecurityGroup\n        - !If [\n            HasClientSecurityGroup1,\n            {\n              'Fn::ImportValue': !Sub '${ParentClientStack1}-ClientSecurityGroup'\n            },\n            !Ref 'AWS::NoValue'\n          ]\n        - !If [\n            HasClientSecurityGroup2,\n            {\n              'Fn::ImportValue': !Sub '${ParentClientStack2}-ClientSecurityGroup'\n            },\n            !Ref 'AWS::NoValue'\n          ]\n        - !If [\n            HasClientSecurityGroup3,\n            {\n              'Fn::ImportValue': !Sub '${ParentClientStack3}-ClientSecurityGroup'\n            },\n            !Ref 'AWS::NoValue'\n          ]\n      SubnetId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-${SubnetName}' }\n  EIPAssociation:\n    Type: 'AWS::EC2::EIPAssociation'\n    Properties:\n      AllocationId: !GetAtt 'ElasticIP.AllocationId'\n      NetworkInterfaceId: !Ref NetworkInterface\n  Logs:\n    Type: 'AWS::Logs::LogGroup'\n    Properties:\n      RetentionInDays: !Ref LogsRetentionInDays\n  SecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: !Ref Name\n      VpcId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC' }\n  SecurityGroupInSSHBastion:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasSSHBastionSecurityGroup\n    Properties:\n      GroupId: !Ref SecurityGroup\n      IpProtocol: tcp\n      FromPort: 22\n      ToPort: 22\n      SourceSecurityGroupId:\n        { 'Fn::ImportValue': !Sub '${ParentSSHBastionStack}-SecurityGroup' }\n  SecurityGroupInSSHWorld:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasNotSSHBastionSecurityGroup\n    Properties:\n      GroupId: !Ref SecurityGroup\n      IpProtocol: tcp\n      FromPort: 22\n      ToPort: 22\n      CidrIp: '0.0.0.0/0'\n  SecurityGroupIngressTcpPort1:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasIngressTcpPort1\n    Properties:\n      GroupId: !Ref SecurityGroup\n      IpProtocol: tcp\n      FromPort: !Ref IngressTcpPort1\n      ToPort: !Ref IngressTcpPort1\n      SourceSecurityGroupId:\n        !If [\n          HasIngressTcpParentClientStack1,\n          {\n            'Fn::ImportValue': !Sub '${IngressTcpParentClientStack1}-ClientSecurityGroup'\n          },\n          !Ref 'AWS::NoValue'\n        ]\n      CidrIp:\n        !If [HasIngressTcpParentClientStack1, !Ref 'AWS::NoValue', '0.0.0.0/0']\n  SecurityGroupIngressTcpPort2:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasIngressTcpPort2\n    Properties:\n      GroupId: !Ref SecurityGroup\n      IpProtocol: tcp\n      FromPort: !Ref IngressTcpPort2\n      ToPort: !Ref IngressTcpPort2\n      SourceSecurityGroupId:\n        !If [\n          HasIngressTcpParentClientStack2,\n          {\n            'Fn::ImportValue': !Sub '${IngressTcpParentClientStack2}-ClientSecurityGroup'\n          },\n          !Ref 'AWS::NoValue'\n        ]\n      CidrIp:\n        !If [HasIngressTcpParentClientStack2, !Ref 'AWS::NoValue', '0.0.0.0/0']\n  SecurityGroupIngressTcpPort3:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasIngressTcpPort3\n    Properties:\n      GroupId: !Ref SecurityGroup\n      IpProtocol: tcp\n      FromPort: !Ref IngressTcpPort3\n      ToPort: !Ref IngressTcpPort3\n      SourceSecurityGroupId:\n        !If [\n          HasIngressTcpParentClientStack3,\n          {\n            'Fn::ImportValue': !Sub '${IngressTcpParentClientStack3}-ClientSecurityGroup'\n          },\n          !Ref 'AWS::NoValue'\n        ]\n      CidrIp:\n        !If [HasIngressTcpParentClientStack3, !Ref 'AWS::NoValue', '0.0.0.0/0']\n  InstanceProfile:\n    Type: 'AWS::IAM::InstanceProfile'\n    Properties:\n      Roles:\n        - !Ref IAMRole\n  IAMRole:\n    Type: 'AWS::IAM::Role'\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: 'ec2.amazonaws.com'\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        !If [\n          HasManagedPolicyArns,\n          !Split [',', !Ref ManagedPolicyArns],\n          !Ref 'AWS::NoValue'\n        ]\n      PermissionsBoundary:\n        !If [\n          HasPermissionsBoundary,\n          !Ref PermissionsBoundary,\n          !Ref 'AWS::NoValue'\n        ]\n      Policies:\n        - PolicyName: ssm\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'ssmmessages:*' # SSM Agent by https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up-messageAPIs.html\n                  - 'ssm:UpdateInstanceInformation' # SSM agent by https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up-messageAPIs.html\n                  - 'ec2messages:*' # SSM Session Manager by https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up-messageAPIs.html\n                  - 'ssm:GetDeployablePatchSnapshotForInstance'\n                  - 'ssm:ListAssociations'\n                Resource: '*'\n              - Effect: Allow\n                Action: 's3:GetObject'\n                Resource:\n                  - !Sub 'arn:${AWS::Partition}:s3:::aws-ssm-${AWS::Region}/*'\n                  - !Sub 'arn:${AWS::Partition}:s3:::patch-baseline-snapshot-${AWS::Region}/*'\n        - PolicyName: cloudwatch\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action: 'cloudwatch:PutMetricData'\n                Resource: '*'\n                Condition:\n                  StringEquals:\n                    'cloudwatch:namespace': !Ref 'AWS::StackName'\n              - Effect: Allow\n                Action:\n                  - 'logs:CreateLogGroup'\n                  - 'logs:CreateLogStream'\n                  - 'logs:PutLogEvents'\n                  - 'logs:DescribeLogStreams'\n                  - 'logs:DescribeLogGroups'\n                Resource: !GetAtt 'Logs.Arn'\n  IAMPolicySSM:\n    Type: 'AWS::IAM::Policy'\n    Properties:\n      Roles:\n        - !Ref IAMRole\n      PolicyName: ssm2\n      PolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Action: 'ssm:ListInstanceAssociations'\n            Resource: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/${VirtualMachine}'\n          - Effect: Allow\n            Action: 'ssm:PutInventory'\n            Resource:\n              - !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/${VirtualMachine}'\n              - !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:managed-instance-inventory/${VirtualMachine}'\n          - Effect: Allow\n            Action: 'ssm:UpdateInstanceAssociationStatus'\n            Resource:\n              - !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/${VirtualMachine}'\n              - !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:association/${AssociationRunPatchBaselineScan}'\n  IAMPolicySSHAccess:\n    Type: 'AWS::IAM::Policy'\n    Condition: HasIAMUserSSHAccess\n    Properties:\n      Roles:\n        - !Ref IAMRole\n      PolicyName: iam\n      PolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Action:\n              - 'iam:ListUsers'\n            Resource:\n              - '*'\n          - Effect: Allow\n            Action:\n              - 'iam:ListSSHPublicKeys'\n              - 'iam:GetSSHPublicKey'\n            Resource:\n              - !Sub 'arn:aws:iam::${AWS::AccountId}:user/*'\n  VirtualMachine: # TODO make IMDSv2 required (waits for https://github.com/aws-cloudformation/aws-cloudformation-coverage-roadmap/issues/655)\n    DependsOn: EIPAssociation\n    Type: 'AWS::EC2::Instance'\n    Metadata:\n      'AWS::CloudFormation::Init':\n        configSets:\n          default:\n            [\n              cloudwatch,\n              !If [HasIAMUserSSHAccess, ssh-access, !Ref 'AWS::NoValue'],\n              config\n            ]\n        cloudwatch:\n          packages:\n            rpm:\n              cloudwatch: 'https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm'\n          files:\n            '/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json': # https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html\n              content: !Sub |\n                {\n                  \"logs\": {\n                    \"logs_collected\": {\n                      \"files\": {\n                        \"collect_list\": [{\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/amazon/amazon-cloudwatch-agent/amazon-cloudwatch-agent.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/amazon/amazon-cloudwatch-agent/amazon-cloudwatch-agent.log\",\n                           \"timestamp_format\": \"%Y-%m-%dT%H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/amazon/amazon-cloudwatch-agent/configuration-validation.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/amazon/amazon-cloudwatch-agent/configuration-validation.log\",\n                           \"timestamp_format\": \"%Y/%m/%d %H:%M:%S\"\n                        }, {\n                          \"log_group_name\": \"${Logs}\",\n                          \"file_path\": \"/var/log/amazon/ssm/amazon-ssm-agent.log\",\n                          \"log_stream_name\": \"{instance_id}/var/log/amazon/ssm/amazon-ssm-agent.log\",\n                          \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/amazon/ssm/errors.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/amazon/ssm/errors.log\",\n                           \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/audit/audit.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/audit/audit.log\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/boot.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/boot.log\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cfn-hup.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cfn-hup.log\",\n                           \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cfn-init-cmd.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cfn-init-cmd.log\",\n                           \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cfn-init.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cfn-init.log\",\n                           \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cfn-wire.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cfn-wire.log\",\n                           \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cloud-init-output.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cloud-init-output.log\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cloud-init.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cloud-init.log\",\n                           \"timestamp_format\": \"%b %d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/cron\",\n                           \"log_stream_name\": \"{instance_id}/var/log/cron\",\n                           \"timestamp_format\": \"%b %-d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/dmesg\",\n                           \"log_stream_name\": \"{instance_id}/var/log/dmesg\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/grubby_prune_debug\",\n                           \"log_stream_name\": \"{instance_id}/var/log/grubby_prune_debug\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/maillog\",\n                           \"log_stream_name\": \"{instance_id}/var/log/maillog\",\n                           \"timestamp_format\": \"%b %-d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/messages\",\n                           \"log_stream_name\": \"{instance_id}/var/log/messages\",\n                           \"timestamp_format\": \"%b %-d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/secure\",\n                           \"log_stream_name\": \"{instance_id}/var/log/secure\",\n                           \"timestamp_format\": \"%b %-d %H:%M:%S\"\n                        }, {\n                           \"log_group_name\": \"${Logs}\",\n                           \"file_path\": \"/var/log/yum.log\",\n                           \"log_stream_name\": \"{instance_id}/var/log/yum.log\",\n                           \"timestamp_format\": \"%b %d %H:%M:%S\"\n                        }]\n                      }\n                    }\n                  },\n                  \"metrics\": {\n                    \"namespace\": \"${AWS::StackName}\",\n                    \"append_dimensions\": {\n                      \"InstanceId\": \"${!aws:InstanceId}\"\n                    },\n                    \"metrics_collected\": {\n                      \"mem\": {\n                        \"measurement\": [\n                          \"mem_used_percent\"\n                        ]\n                      },\n                      \"swap\": {\n                        \"measurement\": [\n                          \"swap_used_percent\"\n                        ]\n                      },\n                      \"disk\": {\n                        \"resources\": [\n                          \"/\"\n                        ],\n                        \"measurement\": [\n                          \"used_percent\"\n                        ],\n                        \"drop_device\": true\n                      }\n                    }\n                  }\n                }\n              mode: '000644'\n              owner: root\n              group: root\n          services:\n            sysvinit:\n              'amazon-cloudwatch-agent':\n                enabled: true\n                ensureRunning: true\n                files:\n                  - '/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json'\n                packages:\n                  - cloudwatch\n        ssh-access:\n          files:\n            '/opt/authorized_keys_command.sh':\n              content: |\n                #!/bin/bash -e\n                if [ -z \"$1\" ]; then\n                  exit 1\n                fi\n                UnsaveUserName=\"$1\"\n                UnsaveUserName=${UnsaveUserName//\".plus.\"/\"+\"}\n                UnsaveUserName=${UnsaveUserName//\".equal.\"/\"=\"}\n                UnsaveUserName=${UnsaveUserName//\".comma.\"/\",\"}\n                UnsaveUserName=${UnsaveUserName//\".at.\"/\"@\"}\n                aws iam list-ssh-public-keys --user-name \"$UnsaveUserName\" --query \"SSHPublicKeys[?Status == 'Active'].[SSHPublicKeyId]\" --output text | while read -r KeyId; do\n                  aws iam get-ssh-public-key --user-name \"$UnsaveUserName\" --ssh-public-key-id \"$KeyId\" --encoding SSH --query \"SSHPublicKey.SSHPublicKeyBody\" --output text\n                done\n              mode: '000755'\n              owner: root\n              group: root\n            '/opt/import_users.sh':\n              content: |\n                #!/bin/bash -e\n                aws iam list-users --query \"Users[].[UserName]\" --output text | while read User; do\n                  SaveUserName=\"$User\"\n                  SaveUserName=${SaveUserName//\"+\"/\".plus.\"}\n                  SaveUserName=${SaveUserName//\"=\"/\".equal.\"}\n                  SaveUserName=${SaveUserName//\",\"/\".comma.\"}\n                  SaveUserName=${SaveUserName//\"@\"/\".at.\"}\n                  if [ \"${#SaveUserName}\" -le \"32\" ]; then\n                    if ! id -u \"$SaveUserName\" \u003e/dev/null 2\u003e\u00261; then\n                      #sudo will read each file in /etc/sudoers.d, skipping file names that end in ?~? or contain a ?.? character to avoid causing problems with package manager or editor temporary/backup files.\n                      SaveUserFileName=$(echo \"$SaveUserName\" | tr \".\" \" \")\n                      /usr/sbin/useradd \"$SaveUserName\"\n                      echo \"$SaveUserName ALL=(ALL) NOPASSWD:ALL\" \u003e \"/etc/sudoers.d/$SaveUserFileName\"\n                    fi\n                  else\n                    echo \"Can not import IAM user ${SaveUserName}. User name is longer than 32 characters.\"\n                  fi\n                done\n              mode: '000755'\n              owner: root\n              group: root\n            '/etc/cron.d/import_users':\n              content: |\n                */10 * * * * root /opt/import_users.sh\n              mode: '000644'\n              owner: root\n              group: root\n          commands:\n            'a_configure_sshd_command':\n              command: 'sed -e ''/AuthorizedKeysCommand / s/^#*/#/'' -i /etc/ssh/sshd_config; echo -e ''\\nAuthorizedKeysCommand /opt/authorized_keys_command.sh'' \u003e\u003e /etc/ssh/sshd_config'\n              test: \"! grep -q '^AuthorizedKeysCommand /opt/authorized_keys_command.sh' /etc/ssh/sshd_config\"\n            'b_configure_sshd_commanduser':\n              command: 'sed -e ''/AuthorizedKeysCommandUser / s/^#*/#/'' -i /etc/ssh/sshd_config; echo -e ''\\nAuthorizedKeysCommandUser nobody'' \u003e\u003e /etc/ssh/sshd_config'\n              test: \"! grep -q '^AuthorizedKeysCommandUser nobody' /etc/ssh/sshd_config\"\n            'c_import_users':\n              command: './import_users.sh'\n              cwd: '/opt'\n          services:\n            sysvinit:\n              sshd:\n                enabled: true\n                ensureRunning: true\n                commands:\n                  - 'a_configure_sshd_command'\n                  - 'b_configure_sshd_commanduser'\n        config:\n          files:\n            '/etc/cfn/cfn-hup.conf':\n              content: !Sub |\n                [main]\n                stack=${AWS::StackId}\n                region=${AWS::Region}\n                interval=1\n              mode: '000400'\n              owner: root\n              group: root\n            '/etc/cfn/hooks.d/cfn-auto-reloader.conf':\n              content: !Sub |\n                [cfn-auto-reloader-hook]\n                triggers=post.update\n                path=Resources.VirtualMachine.Metadata.AWS::CloudFormation::Init\n                action=/opt/aws/bin/cfn-init --verbose --stack=${AWS::StackName} --region=${AWS::Region} --resource=VirtualMachine\n                runas=root\n          services:\n            sysvinit:\n              cfn-hup:\n                enabled: true\n                ensureRunning: true\n                files:\n                  - '/etc/cfn/cfn-hup.conf'\n                  - '/etc/cfn/hooks.d/cfn-auto-reloader.conf'\n              amazon-ssm-agent:\n                enabled: true\n                ensureRunning: true\n    Properties:\n      IamInstanceProfile: !Ref InstanceProfile\n      ImageId:\n        !If [\n          HasRestoreImageId,\n          !Ref RestoreImageId,\n          !FindInMap [\n            !FindInMap [VersionMap, !Ref AmazonLinux2Version, Map],\n            !Ref 'AWS::Region',\n            AMI\n          ]\n        ]\n      InstanceType: !Ref InstanceType\n      KeyName: !If [HasKeyName, !Ref KeyName, !Ref 'AWS::NoValue']\n      BlockDeviceMappings:\n        - DeviceName: '/dev/xvda'\n          Ebs:\n            Encrypted: !If [HasKmsKey, true, !Ref 'AWS::NoValue']\n            KmsKeyId:\n              !If [\n                HasKmsKey,\n                { 'Fn::ImportValue': !Sub '${ParentKmsKeyStack}-KeyArn' },\n                !Ref 'AWS::NoValue'\n              ]\n            VolumeSize: !Ref RootVolumeSize\n            VolumeType: gp2\n      NetworkInterfaces:\n        - DeviceIndex: '0'\n          NetworkInterfaceId: !Ref NetworkInterface\n      UserData:\n        'Fn::Base64': !Sub |\n          #!/bin/bash -ex\n          trap '/opt/aws/bin/cfn-signal -e 1 --region ${AWS::Region} --stack ${AWS::StackName} --resource VirtualMachine' ERR\n          ${UserData}\n          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource VirtualMachine --region ${AWS::Region}\n          /opt/aws/bin/cfn-signal -e 0 --region ${AWS::Region} --stack ${AWS::StackName} --resource VirtualMachine\n      Tags:\n        - Key: Name\n          Value: !Ref Name\n    CreationPolicy:\n      ResourceSignal:\n        Count: 1\n        Timeout: PT10M\n  RecoveryAlarm:\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Recovering instance when underlying hardware fails.'\n      Namespace: 'AWS/EC2'\n      MetricName: StatusCheckFailed_System\n      Statistic: Minimum\n      Period: 60\n      EvaluationPeriods: 5\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 0\n      AlarmActions:\n        - !Sub 'arn:aws:automate:${AWS::Region}:ec2:recover'\n      Dimensions:\n        - Name: InstanceId\n          Value: !Ref VirtualMachine\n  CPUTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Average CPU utilization over last 10 minutes higher than 80%'\n      Namespace: 'AWS/EC2'\n      MetricName: CPUUtilization\n      Statistic: Average\n      Period: 600\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 80\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: InstanceId\n          Value: !Ref VirtualMachine\n  MemoryTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Average memory utilization over last 10 minutes higher than 80%'\n      Namespace: !Ref 'AWS::StackName'\n      MetricName: mem_used_percent\n      Statistic: Average\n      Period: 600\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 80\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: InstanceId\n          Value: !Ref VirtualMachine\n  DiskTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Average disk utilization over last 10 minutes higher than 80%'\n      Namespace: !Ref 'AWS::StackName'\n      MetricName: disk_used_percent\n      Statistic: Average\n      Period: 600\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 80\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: InstanceId\n          Value: !Ref VirtualMachine\n        - Name: fstype\n          Value: xfs\n        - Name: path\n          Value: '/'\n  MaintenanceWindow:\n    Type: 'AWS::SSM::MaintenanceWindow'\n    Properties:\n      AllowUnassociatedTargets: false\n      Cutoff: 1\n      Duration: 2\n      Name: !Ref 'AWS::StackName'\n      Schedule: !Ref MaintenanceWindowSchedule\n      ScheduleTimezone: !Ref MaintenanceWindowScheduleTimezone\n  MaintenanceWindowTarget:\n    Type: 'AWS::SSM::MaintenanceWindowTarget'\n    Properties:\n      ResourceType: INSTANCE\n      Targets:\n        - Key: InstanceIds\n          Values: [!Ref VirtualMachine]\n      WindowId: !Ref MaintenanceWindow\n  MaintenanceWindowTask:\n    Type: 'AWS::SSM::MaintenanceWindowTask'\n    Properties:\n      MaxConcurrency: '1'\n      MaxErrors: '1'\n      Priority: 0\n      Targets:\n        - Key: WindowTargetIds\n          Values: [!Ref MaintenanceWindowTarget]\n      TaskArn: 'AWS-RunPatchBaseline'\n      TaskInvocationParameters:\n        MaintenanceWindowRunCommandParameters:\n          Parameters:\n            Operation: [Install]\n      TaskType: 'RUN_COMMAND'\n      WindowId: !Ref MaintenanceWindow\n  AssociationRunPatchBaselineScan:\n    Type: 'AWS::SSM::Association'\n    Properties:\n      Name: 'AWS-RunPatchBaseline'\n      Parameters:\n        Operation: [Scan]\n      ScheduleExpression: 'rate(1 hour)'\n      Targets:\n        - Key: InstanceIds\n          Values: [!Ref VirtualMachine]\n  BackupVault: # cannot be deleted with data\n    Condition: HasBackupRetentionPeriod\n    Type: 'AWS::Backup::BackupVault'\n    Properties:\n      BackupVaultName: !Ref 'AWS::StackName'\n      Notifications:\n        !If [\n          HasAlertTopic,\n          {\n            BackupVaultEvents:\n              [\n                BACKUP_JOB_STARTED,\n                BACKUP_JOB_COMPLETED,\n                RESTORE_JOB_STARTED,\n                RESTORE_JOB_COMPLETED,\n                RECOVERY_POINT_MODIFIED\n              ],\n            SNSTopicArn:\n              { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n          },\n          !Ref 'AWS::NoValue'\n        ]\n  BackupPlan:\n    Condition: HasBackupRetentionPeriod\n    Type: 'AWS::Backup::BackupPlan'\n    Properties:\n      BackupPlan:\n        BackupPlanName: !Ref 'AWS::StackName'\n        BackupPlanRule:\n          - CompletionWindowMinutes: 1440\n            Lifecycle:\n              DeleteAfterDays: !Ref BackupRetentionPeriod\n            RuleName: !Ref 'AWS::StackName'\n            ScheduleExpression: !Ref BackupScheduleExpression\n            StartWindowMinutes: 60\n            TargetBackupVault: !Ref BackupVault\n  BackupRole:\n    Condition: HasBackupRetentionPeriod\n    Type: 'AWS::IAM::Role'\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: 'backup.amazonaws.com'\n            Action: 'sts:AssumeRole'\n      PermissionsBoundary:\n        !If [\n          HasPermissionsBoundary,\n          !Ref PermissionsBoundary,\n          !Ref 'AWS::NoValue'\n        ]\n      Policies:\n        - PolicyName: backup\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'ec2:CreateTags'\n                  - 'ec2:DeleteSnapshot'\n                Resource: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*'\n              - Effect: Allow\n                Action:\n                  - 'ec2:CreateImage'\n                  - 'ec2:DeregisterImage'\n                  - 'ec2:DescribeSnapshots'\n                  - 'ec2:DescribeTags'\n                  - 'ec2:DescribeImages'\n                  - 'ec2:DescribeInstances'\n                  - 'ec2:DescribeInstanceAttribute'\n                  - 'ec2:DescribeInstanceCreditSpecifications'\n                  - 'ec2:DescribeNetworkInterfaces'\n                  - 'ec2:DescribeElasticGpus'\n                  - 'ec2:DescribeSpotInstanceRequests'\n                Resource: '*'\n              - Effect: Allow\n                Action: 'ec2:CreateTags'\n                Resource: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}::image/*'\n              - Effect: Allow\n                Action:\n                  - 'ec2:CreateSnapshot'\n                  - 'ec2:DeleteSnapshot'\n                  - 'ec2:DescribeVolumes'\n                  - 'ec2:DescribeSnapshots'\n                Resource:\n                  - !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*'\n                  - !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:volume/*'\n  BackupSelection:\n    Condition: HasBackupRetentionPeriod\n    Type: 'AWS::Backup::BackupSelection'\n    Properties:\n      BackupPlanId: !Ref BackupPlan\n      BackupSelection:\n        IamRoleArn: !GetAtt 'BackupRole.Arn'\n        Resources:\n          - !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/${VirtualMachine}'\n        SelectionName: !Ref 'AWS::StackName'\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'ec2/al2-mutable-public'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '__VERSION__'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n  InstanceId:\n    Description: 'The EC2 instance id.'\n    Value: !Ref VirtualMachine\n    Export:\n      Name: !Sub '${AWS::StackName}-InstanceId'\n  PublicIPAddress:\n    Description: 'The public IP address of the EC2 instance.'\n    Value: !Ref ElasticIP\n    Export:\n      Name: !Sub '${AWS::StackName}-IPAddress'\n  PrivateIPAddress:\n    Description: 'The private IP address of the EC2 instance.'\n    Value: !GetAtt 'NetworkInterface.PrimaryPrivateIpAddress'\n    Export:\n      Name: !Sub '${AWS::StackName}-PrivateIPAddress'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "aws_cloudformation_stack.client_sg"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "ecs_cluster",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-cluster-stack/0c19b730-7018-11eb-aec0-0a0703eab8ad",
            "name": "commons-cluster-stack",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "CanonicalHostedZoneID": "Z35SXDOTRQ7X7K",
              "Cluster": "commons-cluster",
              "DNSName": "commo-LoadB-1Y0S5TB31IQ0D-1561513888.us-east-1.elb.amazonaws.com",
              "HttpListener": "arn:aws:elasticloadbalancing:us-east-1:246369665268:listener/app/commo-LoadB-1Y0S5TB31IQ0D/81894e35a34b3a62/7cf07933c25f27f4",
              "LoadBalancerFullName": "app/commo-LoadB-1Y0S5TB31IQ0D/81894e35a34b3a62",
              "LoadBalancerSecurityGroup": "sg-079ddc9e61328d931",
              "StackName": "commons-cluster-stack",
              "TemplateID": "fargate/cluster",
              "TemplateVersion": "__VERSION__",
              "URL": "http://commo-LoadB-1Y0S5TB31IQ0D-1561513888.us-east-1.elb.amazonaws.com"
            },
            "parameters": {
              "ClusterName": "commons-cluster",
              "ParentVPCStack": "commons-vpc-stack"
            },
            "policy_body": null,
            "policy_url": null,
            "tags": {},
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'Fargate: cluster, a cloudonaut.io template'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'Parent Stacks'\n        Parameters:\n          - ParentVPCStack\n          - ParentAuthProxyStack\n          - ParentAlertStack\n          - ParentZoneStack\n          - ParentS3StackAccessLog\n          - ParentWAFStack\n      - Label:\n          default: 'Load Balancer Parameters'\n        Parameters:\n          - LoadBalancerScheme\n          - LoadBalancerCertificateArn\n          - LoadBalancerIdleTimeout\n          - SubDomainNameWithDot\nParameters:\n  ClusterName:\n    Type: String\n    Description: Name of the ECS cluster to be created\n  ParentVPCStack:\n    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'\n    Type: String\n  ParentAuthProxyStack:\n    Description: 'Optional stack name of parent auth proxy stack based on security/auth-proxy-*.yaml template.'\n    Type: String\n    Default: ''\n  ParentAlertStack:\n    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'\n    Type: String\n    Default: ''\n  ParentZoneStack:\n    Description: 'Optional stack name of parent zone stack based on vpc/zone-*.yaml template.'\n    Type: String\n    Default: ''\n  ParentS3StackAccessLog:\n    Description: 'Optional stack name of parent s3 stack based on state/s3.yaml template (with Access set to ElbAccessLogWrite) to store access logs.'\n    Type: String\n    Default: ''\n  ParentWAFStack:\n    Description: 'Optional stack name of parent WAF stack based on the security/waf.yaml template.'\n    Type: String\n    Default: ''\n  LoadBalancerScheme:\n    Description: 'Indicates whether the load balancer in front of the ECS service is internet-facing or internal.'\n    Type: String\n    Default: 'internet-facing'\n    AllowedValues:\n      - 'internet-facing'\n      - 'internal'\n  LoadBalancerCertificateArn:\n    Description: 'Optional Amazon Resource Name (ARN) of the certificate to associate with the load balancer. If set, HTTP requests are redirected to HTTPS.'\n    Type: String\n    Default: ''\n  LoadBalancerIdleTimeout:\n    Description: 'The idle timeout value, in seconds.'\n    Type: Number\n    Default: 60\n    MinValue: 1\n    MaxValue: 4000\n  SubDomainNameWithDot:\n    Description: 'Name that is used to create the DNS entry with trailing dot, e.g. ?{SubDomainNameWithDot}?{HostedZoneName}. Leave blank for naked (or apex and bare) domain. Requires ParentZoneStack parameter!'\n    Type: String\n    Default: ''\nConditions:\n  HasAuthProxySecurityGroup: !Not [!Equals [!Ref ParentAuthProxyStack, '']]\n  HasNotAuthProxySecurityGroup: !Equals [!Ref ParentAuthProxyStack, '']\n  HasLoadBalancerSchemeInternetFacing:\n    !Equals [!Ref LoadBalancerScheme, 'internet-facing']\n  HasLoadBalancerSchemeInternal: !Equals [!Ref LoadBalancerScheme, 'internal']\n  HasLoadBalancerCertificateArn:\n    !Not [!Equals [!Ref LoadBalancerCertificateArn, '']]\n  HasAuthProxySecurityGroupAndLoadBalancerCertificateArn:\n    !And [\n      !Condition HasAuthProxySecurityGroup,\n      !Condition HasLoadBalancerCertificateArn\n    ]\n  HasNotAuthProxySecurityGroupAndLoadBalancerCertificateArn:\n    !And [\n      !Condition HasNotAuthProxySecurityGroup,\n      !Condition HasLoadBalancerCertificateArn\n    ]\n  HasAlertTopic: !Not [!Equals [!Ref ParentAlertStack, '']]\n  HasZone: !Not [!Equals [!Ref ParentZoneStack, '']]\n  HasZoneAndLoadBalancerSchemeInternetFacing:\n    !And [!Condition HasZone, !Condition HasLoadBalancerSchemeInternetFacing]\n  HasS3Bucket: !Not [!Equals [!Ref ParentS3StackAccessLog, '']]\n  HasWAF: !Not [!Equals [!Ref ParentWAFStack, '']]\nResources:\n  Cluster:\n    Type: 'AWS::ECS::Cluster'\n    Properties:\n      ClusterName: !Ref 'ClusterName'\n  RecordSet:\n    Condition: HasZone\n    Type: 'AWS::Route53::RecordSet'\n    Properties:\n      AliasTarget:\n        HostedZoneId: !GetAtt LoadBalancer.CanonicalHostedZoneID\n        DNSName: !GetAtt 'LoadBalancer.DNSName'\n      HostedZoneId:\n        { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneId' }\n      Name: !Sub\n        - '${SubDomainNameWithDot}${HostedZoneName}'\n        - SubDomainNameWithDot: !Ref SubDomainNameWithDot\n          HostedZoneName:\n            { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneName' }\n      Type: A\n  RecordSetIPv6:\n    Condition: HasZoneAndLoadBalancerSchemeInternetFacing\n    Type: 'AWS::Route53::RecordSet'\n    Properties:\n      AliasTarget:\n        HostedZoneId: !GetAtt LoadBalancer.CanonicalHostedZoneID\n        DNSName: !GetAtt 'LoadBalancer.DNSName'\n      HostedZoneId:\n        { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneId' }\n      Name: !Sub\n        - '${SubDomainNameWithDot}${HostedZoneName}'\n        - SubDomainNameWithDot: !Ref SubDomainNameWithDot\n          HostedZoneName:\n            { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneName' }\n      Type: AAAA\n  LoadBalancerSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: !Sub '${AWS::StackName}-load-balancer'\n      VpcId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC' }\n  LoadBalancerSecurityGroupInHttpFromWorld:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasNotAuthProxySecurityGroup\n    Properties:\n      GroupId: !Ref LoadBalancerSecurityGroup\n      IpProtocol: tcp\n      FromPort: 80\n      ToPort: 80\n      CidrIp: '0.0.0.0/0'\n  LoadBalancerSecurityGroupInHttpFromWorldIPv6:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasNotAuthProxySecurityGroup\n    Properties:\n      GroupId: !Ref LoadBalancerSecurityGroup\n      IpProtocol: tcp\n      FromPort: 80\n      ToPort: 80\n      CidrIpv6: '::/0'\n  LoadBalancerSecurityGroupInHttpsFromWorld:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasNotAuthProxySecurityGroupAndLoadBalancerCertificateArn\n    Properties:\n      GroupId: !Ref LoadBalancerSecurityGroup\n      IpProtocol: tcp\n      FromPort: 443\n      ToPort: 443\n      CidrIp: '0.0.0.0/0'\n  LoadBalancerSecurityGroupInHttpsFromWorldIPv6:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasNotAuthProxySecurityGroupAndLoadBalancerCertificateArn\n    Properties:\n      GroupId: !Ref LoadBalancerSecurityGroup\n      IpProtocol: tcp\n      FromPort: 443\n      ToPort: 443\n      CidrIpv6: '::/0'\n  LoadBalancerSecurityGroupInHttpFromAuthProxy:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasAuthProxySecurityGroup\n    Properties:\n      GroupId: !Ref LoadBalancerSecurityGroup\n      IpProtocol: tcp\n      FromPort: 80\n      ToPort: 80\n      SourceSecurityGroupId:\n        { 'Fn::ImportValue': !Sub '${ParentAuthProxyStack}-SecurityGroup' }\n  LoadBalancerSecurityGroupInHttpsFromAuthProxy:\n    Type: 'AWS::EC2::SecurityGroupIngress'\n    Condition: HasAuthProxySecurityGroupAndLoadBalancerCertificateArn\n    Properties:\n      GroupId: !Ref LoadBalancerSecurityGroup\n      IpProtocol: tcp\n      FromPort: 443\n      ToPort: 443\n      SourceSecurityGroupId:\n        { 'Fn::ImportValue': !Sub '${ParentAuthProxyStack}-SecurityGroup' }\n  LoadBalancer:\n    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'\n    Properties:\n      IpAddressType: !If [HasLoadBalancerSchemeInternal, 'ipv4', 'dualstack']\n      LoadBalancerAttributes:\n        - Key: 'idle_timeout.timeout_seconds'\n          Value: !Ref LoadBalancerIdleTimeout\n        - Key: 'routing.http2.enabled'\n          Value: 'true'\n        - Key: 'access_logs.s3.enabled'\n          Value: !If [HasS3Bucket, 'true', 'false']\n        - !If [\n            HasS3Bucket,\n            { Key: 'access_logs.s3.prefix', Value: !Ref 'AWS::StackName' },\n            !Ref 'AWS::NoValue'\n          ]\n        - !If [\n            HasS3Bucket,\n            {\n              Key: 'access_logs.s3.bucket',\n              Value:\n                {\n                  'Fn::ImportValue': !Sub '${ParentS3StackAccessLog}-BucketName'\n                }\n            },\n            !Ref 'AWS::NoValue'\n          ]\n      Scheme: !Ref LoadBalancerScheme\n      SecurityGroups:\n        - !Ref LoadBalancerSecurityGroup\n      Subnets: !If\n        - HasLoadBalancerSchemeInternal\n        - !Split [\n            ',',\n            { 'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetsPrivate' }\n          ]\n        - !Split [\n            ',',\n            { 'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetsPublic' }\n          ]\n      Type: application\n  WebACLAssociation:\n    Condition: HasWAF\n    Type: AWS::WAFv2::WebACLAssociation\n    Properties:\n      ResourceArn: !Ref LoadBalancer\n      WebACLArn: { 'Fn::ImportValue': !Sub '${ParentWAFStack}-WebACL' }\n  HTTPCodeELB5XXTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Application load balancer returns 5XX HTTP status codes'\n      Namespace: 'AWS/ApplicationELB'\n      MetricName: HTTPCode_ELB_5XX_Count\n      Statistic: Sum\n      Period: 60\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 0\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: LoadBalancer\n          Value: !GetAtt 'LoadBalancer.LoadBalancerFullName'\n      TreatMissingData: notBreaching\n  RejectedConnectionCountTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Application load balancer rejected connections because the load balancer had reached its maximum number of connections'\n      Namespace: 'AWS/ApplicationELB'\n      MetricName: RejectedConnectionCount\n      Statistic: Sum\n      Period: 60\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 0\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: LoadBalancer\n          Value: !GetAtt 'LoadBalancer.LoadBalancerFullName'\n      TreatMissingData: notBreaching\n  HttpListener:\n    Type: 'AWS::ElasticLoadBalancingV2::Listener'\n    Properties:\n      DefaultActions:\n        - !If\n          - HasLoadBalancerCertificateArn\n          - RedirectConfig:\n              Port: '443'\n              Protocol: HTTPS\n              StatusCode: 'HTTP_301'\n            Type: redirect\n          - FixedResponseConfig:\n              ContentType: 'text/plain'\n              MessageBody: default\n              StatusCode: '404'\n            Type: 'fixed-response'\n      LoadBalancerArn: !Ref LoadBalancer\n      Port: 80\n      Protocol: HTTP\n  HttpsListener:\n    Condition: HasLoadBalancerCertificateArn\n    Type: 'AWS::ElasticLoadBalancingV2::Listener'\n    Properties:\n      Certificates:\n        - CertificateArn: !Ref LoadBalancerCertificateArn\n      DefaultActions:\n        - FixedResponseConfig:\n            ContentType: 'text/plain'\n            MessageBody: default\n            StatusCode: '404'\n          Type: 'fixed-response'\n      LoadBalancerArn: !Ref LoadBalancer\n      Port: 443\n      Protocol: HTTPS\n      SslPolicy: 'ELBSecurityPolicy-FS-1-2-Res-2019-08'\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'fargate/cluster'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '__VERSION__'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n  Cluster:\n    Description: 'Fargate cluster.'\n    Value: !Ref Cluster\n    Export:\n      Name: !Sub '${AWS::StackName}-Cluster'\n  DNSName:\n    Description: 'The DNS name for the ECS cluster load balancer.'\n    Value: !GetAtt 'LoadBalancer.DNSName'\n    Export:\n      Name: !Sub '${AWS::StackName}-DNSName'\n  URL:\n    Description: 'URL to the ECS cluster.'\n    Value: !Sub 'http://${LoadBalancer.DNSName}'\n    Export:\n      Name: !Sub '${AWS::StackName}-URL'\n  CanonicalHostedZoneID:\n    Description: 'The ID of the Amazon Route 53 hosted zone associated with the load balancer.'\n    Value: !GetAtt LoadBalancer.CanonicalHostedZoneID\n    Export:\n      Name: !Sub '${AWS::StackName}-CanonicalHostedZoneID'\n  LoadBalancerFullName:\n    Description: 'ALB full name for services.'\n    Value: !GetAtt 'LoadBalancer.LoadBalancerFullName'\n    Export:\n      Name: !Sub '${AWS::StackName}-LoadBalancerFullName'\n  LoadBalancerSecurityGroup:\n    Description: 'The Security Group of the Load Balancer.'\n    Value: !Ref LoadBalancerSecurityGroup\n    Export:\n      Name: !Sub '${AWS::StackName}-LoadBalancerSecurityGroup'\n  HttpListener:\n    Description: 'ALB HTTP listener for services.'\n    Value: !Ref HttpListener\n    Export:\n      Name: !Sub '${AWS::StackName}-HttpListener'\n  HttpsListener:\n    Condition: HasLoadBalancerCertificateArn\n    Description: 'ALB HTTPS listener for services.'\n    Value: !Ref HttpsListener\n    Export:\n      Name: !Sub '${AWS::StackName}-HttpsListener'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "aws_cloudformation_stack.vpc"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "ecs_service",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-svc-stack/61c8fce0-7018-11eb-a504-120bf1e0775b",
            "name": "commons-svc-stack",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "StackName": "commons-svc-stack",
              "TemplateID": "fargate/service-cluster-alb",
              "TemplateVersion": "__VERSION__"
            },
            "parameters": {
              "DesiredCount": "2",
              "ParentClientStack1": "commons-client-sg-stack",
              "ParentClusterStack": "commons-cluster-stack",
              "ParentVPCStack": "commons-vpc-stack",
              "ServiceName": "commons-service",
              "SubnetsReach": "Public"
            },
            "policy_body": null,
            "policy_url": null,
            "tags": {},
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'Fargate: service that runs on a Fargate cluster based on fargate/cluster.yaml and uses the cluster ALB, a cloudonaut.io template'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'Parent Stacks'\n        Parameters:\n          - ParentVPCStack\n          - ParentClusterStack\n          - ParentAlertStack\n          - ParentZoneStack\n          - ParentClientStack1\n          - ParentClientStack2\n          - ParentClientStack3\n      - Label:\n          default: 'Load Balancer Parameters'\n        Parameters:\n          - LoadBalancerPriority\n          - LoadBalancerHostPattern\n          - LoadBalancerPathPattern\n          - LoadBalancerHttps\n          - LoadBalancerDeregistrationDelay\n      - Label:\n          default: 'Task Parameters'\n        Parameters:\n          - TaskPolicies\n          - ProxyImage\n          - ProxyCommand\n          - ProxyPort\n          - ProxyEnvironment1Key\n          - ProxyEnvironment1Value\n          - ProxyEnvironment2Key\n          - ProxyEnvironment2Value\n          - ProxyEnvironment3Key\n          - ProxyEnvironment3Value\n          - AppImage\n          - AppCommand\n          - AppPort\n          - AppEnvironment1Key\n          - AppEnvironment1Value\n          - AppEnvironment2Key\n          - AppEnvironment2Value\n          - AppEnvironment3Key\n          - AppEnvironment3Value\n          - SidecarImage\n          - SidecarCommand\n          - SidecarPort\n          - SidecarEnvironment1Key\n          - SidecarEnvironment1Value\n          - SidecarEnvironment2Key\n          - SidecarEnvironment2Value\n          - SidecarEnvironment3Key\n          - SidecarEnvironment3Value\n      - Label:\n          default: 'Service Parameters'\n        Parameters:\n          - SubDomainNameWithDot\n          - Cpu\n          - Memory\n          - SubnetsReach\n          - AutoScaling\n          - DesiredCount\n          - MaxCapacity\n          - MinCapacity\n          - HealthCheckGracePeriod\n          - LogsRetentionInDays\n      - Label:\n          default: 'Permission Parameters'\n        Parameters:\n          - PermissionsBoundary\nParameters:\n  ServiceName:\n    Type: String\n    Description: A name for the service\n  ParentVPCStack:\n    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'\n    Type: String\n  ParentClusterStack:\n    Description: 'Stack name of parent Cluster stack based on fargate/cluster.yaml template.'\n    Type: String\n  ParentAlertStack:\n    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'\n    Type: String\n    Default: ''\n  ParentZoneStack:\n    Description: 'Optional stack name of parent zone stack based on vpc/zone-*.yaml template.'\n    Type: String\n    Default: ''\n  ParentClientStack1:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the service to whatever uses the client security group.'\n    Type: String\n    Default: ''\n  ParentClientStack2:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the service to whatever uses the client security group.'\n    Type: String\n    Default: ''\n  ParentClientStack3:\n    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the service to whatever uses the client security group.'\n    Type: String\n    Default: ''\n  PermissionsBoundary:\n    Description: 'Optional ARN for a policy that will be used as the permission boundary for all roles created by this template.'\n    Type: String\n    Default: ''\n  LoadBalancerPriority:\n    Description: 'The priority for the rule. Elastic Load Balancing evaluates rules in priority order, from the lowest value to the highest value. If a request satisfies a rule, Elastic Load Balancing ignores all subsequent rules. A target group can have only one rule with a given priority.'\n    Type: Number\n    Default: 1\n    ConstraintDescription: 'Must be in the range [1-99999]'\n    MinValue: 1\n    MaxValue: 99999\n  LoadBalancerHostPattern:\n    Description: 'Optional host pattern. Specify LoadBalancerPathPattern and/or LoadBalancerHostPattern.'\n    Type: String\n    Default: ''\n    ConstraintDescription: 'Must not be longer than 255'\n    MaxLength: 255\n  LoadBalancerPathPattern:\n    Description: 'Optional path pattern. Specify LoadBalancerPathPattern and/or LoadBalancerHostPattern.'\n    Type: String\n    Default: '/*'\n    ConstraintDescription: 'Must not be longer than 255'\n    MaxLength: 255\n  LoadBalancerHttps:\n    Description: 'If the cluster supports HTTPS (LoadBalancerCertificateArn is set) you can enable HTTPS for the service'\n    Type: String\n    Default: false\n    AllowedValues:\n      - true\n      - false\n  LoadBalancerDeregistrationDelay:\n    Description: 'The amount time (in seconds) to wait before changing the state of a deregistering target from draining to unused.'\n    Type: Number\n    Default: 60\n    ConstraintDescription: 'Must be in the range [0-3600]'\n    MinValue: 0\n    MaxValue: 3600\n  TaskPolicies:\n    Description: 'Comma-delimited list of IAM managed policy ARNs to attach to the task IAM role'\n    Type: String\n    Default: ''\n  ProxyImage:\n    Description: 'Optional Docker image to use for the proxy container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag).'\n    Type: String\n    Default: ''\n  ProxyCommand:\n    Description: 'Optional command used when starting the proxy container.'\n    Type: String\n    Default: ''\n  ProxyPort:\n    Description: 'The port exposed by the proxy container that receives traffic from the load balancer (ProxyPort \u003c\u003e AppPort \u003c\u003e SidecarPort; ignored if ProxyImage is not set).'\n    Type: Number\n    Default: 8000\n    MinValue: 1\n    MaxValue: 49150\n  ProxyEnvironment1Key:\n    Description: 'Optional environment variable 1 key for proxy container.'\n    Type: String\n    Default: ''\n  ProxyEnvironment1Value:\n    Description: 'Optional environment variable 1 value for proxy container.'\n    Type: String\n    Default: ''\n  ProxyEnvironment2Key:\n    Description: 'Optional environment variable 2 key for proxy container.'\n    Type: String\n    Default: ''\n  ProxyEnvironment2Value:\n    Description: 'Optional environment variable 2 value for proxy container.'\n    Type: String\n    Default: ''\n  ProxyEnvironment3Key:\n    Description: 'Optional environment variable 3 key for proxy container.'\n    Type: String\n    Default: ''\n  ProxyEnvironment3Value:\n    Description: 'Optional environment variable 3 value for proxy container.'\n    Type: String\n    Default: ''\n  AppImage:\n    Description: 'The Docker image to use for the app container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag).'\n    Type: String\n    Default: 'nginx'\n  AppCommand:\n    Description: 'Optional commands (comma-delimited) used when starting the app container.'\n    Type: String\n    Default: ''\n  AppPort:\n    Description: 'The port exposed by the app container that receives traffic from the load balancer or the proxy container (AppPort \u003c\u003e ProxyPort \u003c\u003e SidecarPort).'\n    Type: Number\n    Default: 80\n    MinValue: 1\n    MaxValue: 49150\n  AppEnvironment1Key:\n    Description: 'Optional environment variable 1 key for app container.'\n    Type: String\n    Default: ''\n  AppEnvironment1Value:\n    Description: 'Optional environment variable 1 value for app container.'\n    Type: String\n    Default: ''\n  AppEnvironment2Key:\n    Description: 'Optional environment variable 2 key for app container.'\n    Type: String\n    Default: ''\n  AppEnvironment2Value:\n    Description: 'Optional environment variable 2 value for app container.'\n    Type: String\n    Default: ''\n  AppEnvironment3Key:\n    Description: 'Optional environment variable 3 key for app container.'\n    Type: String\n    Default: ''\n  AppEnvironment3Value:\n    Description: 'Optional environment variable 3 value for app container.'\n    Type: String\n    Default: ''\n  SidecarImage:\n    Description: 'Optional Docker image to use for the sidecar container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag).'\n    Type: String\n    Default: ''\n  SidecarCommand:\n    Description: 'Optional command used when starting the sidecar container.'\n    Type: String\n    Default: ''\n  SidecarPort:\n    Description: 'The port exposed by the sidecar container reachable from the app container on host localhost (SidecarPort \u003c\u003e ProxyPort \u003c\u003e AppPort).'\n    Type: Number\n    Default: 9000\n    MinValue: 1\n    MaxValue: 49150\n  SidecarEnvironment1Key:\n    Description: 'Optional environment variable 1 key for sidecar container.'\n    Type: String\n    Default: ''\n  SidecarEnvironment1Value:\n    Description: 'Optional environment variable 1 value for sidecar container.'\n    Type: String\n    Default: ''\n  SidecarEnvironment2Key:\n    Description: 'Optional environment variable 2 key for sidecar container.'\n    Type: String\n    Default: ''\n  SidecarEnvironment2Value:\n    Description: 'Optional environment variable 2 value for sidecar container.'\n    Type: String\n    Default: ''\n  SidecarEnvironment3Key:\n    Description: 'Optional environment variable 3 key for sidecar container.'\n    Type: String\n    Default: ''\n  SidecarEnvironment3Value:\n    Description: 'Optional environment variable 3 value for sidecar container.'\n    Type: String\n    Default: ''\n  SubDomainNameWithDot:\n    Description: 'Name that is used to create the DNS entry with trailing dot, e.g. ?{SubDomainNameWithDot}?{HostedZoneName}. Leave blank for naked (or apex and bare) domain. Requires ParentZoneStack parameter!'\n    Type: String\n    Default: ''\n  Cpu:\n    Description: 'The minimum number of vCPUs to reserve for the container.'\n    Type: String\n    Default: '0.25'\n    AllowedValues: ['0.25', '0.5', '1', '2', '4']\n  Memory:\n    Description: 'The amount (in GB) of memory used by the task.'\n    Type: String\n    Default: '0.5'\n    AllowedValues:\n      [\n        '0.5',\n        '1',\n        '2',\n        '3',\n        '4',\n        '5',\n        '6',\n        '7',\n        '8',\n        '9',\n        '10',\n        '11',\n        '12',\n        '13',\n        '14',\n        '15',\n        '16',\n        '17',\n        '18',\n        '19',\n        '20',\n        '21',\n        '22',\n        '23',\n        '24',\n        '25',\n        '26',\n        '27',\n        '28',\n        '29',\n        '30'\n      ]\n  DesiredCount:\n    Description: 'The number of simultaneous tasks, that you want to run on the cluster.'\n    Type: Number\n    Default: 2\n    ConstraintDescription: 'Must be \u003e= 1'\n    MinValue: 1\n  MaxCapacity:\n    Description: 'The maximum number of simultaneous tasks, that you want to run on the cluster.'\n    Type: Number\n    Default: 4\n    ConstraintDescription: 'Must be \u003e= 1'\n    MinValue: 1\n  MinCapacity:\n    Description: 'The minimum number of simultaneous tasks, that you want to run on the cluster.'\n    Type: Number\n    Default: 2\n    ConstraintDescription: 'Must be \u003e= 1'\n    MinValue: 1\n  LogsRetentionInDays:\n    Description: 'Specifies the number of days you want to retain log events in the specified log group.'\n    Type: Number\n    Default: 14\n    AllowedValues:\n      [\n        1,\n        3,\n        5,\n        7,\n        14,\n        30,\n        60,\n        90,\n        120,\n        150,\n        180,\n        365,\n        400,\n        545,\n        731,\n        1827,\n        3653\n      ]\n  SubnetsReach:\n    Description: 'Should the service have direct access to the Internet or do you prefer private subnets with NAT?'\n    Type: String\n    Default: Public\n    AllowedValues:\n      - Public\n      - Private\n  AutoScaling:\n    Description: 'Scale number of tasks based on CPU load?'\n    Type: String\n    Default: 'true'\n    AllowedValues: ['true', 'false']\n  HealthCheckGracePeriod:\n    Description: 'The period of time, in seconds, that the Amazon ECS service scheduler ignores unhealthy Elastic Load Balancing target health checks after a task has first started.'\n    Type: Number\n    Default: 60\n    MinValue: 0\n    MaxValue: 1800\nMappings:\n  CpuMap:\n    '0.25':\n      Cpu: 256\n    '0.5':\n      Cpu: 512\n    '1':\n      Cpu: 1024\n    '2':\n      Cpu: 2048\n    '4':\n      Cpu: 4096\n  MemoryMap:\n    '0.5':\n      Memory: 512\n    '1':\n      Memory: 1024\n    '2':\n      Memory: 2048\n    '3':\n      Memory: 3072\n    '4':\n      Memory: 4096\n    '5':\n      Memory: 5120\n    '6':\n      Memory: 6144\n    '7':\n      Memory: 7168\n    '8':\n      Memory: 8192\n    '9':\n      Memory: 9216\n    '10':\n      Memory: 10240\n    '11':\n      Memory: 11264\n    '12':\n      Memory: 12288\n    '13':\n      Memory: 13312\n    '14':\n      Memory: 14336\n    '15':\n      Memory: 15360\n    '16':\n      Memory: 16384\n    '17':\n      Memory: 17408\n    '18':\n      Memory: 18432\n    '19':\n      Memory: 19456\n    '20':\n      Memory: 20480\n    '21':\n      Memory: 21504\n    '22':\n      Memory: 22528\n    '23':\n      Memory: 23552\n    '24':\n      Memory: 24576\n    '25':\n      Memory: 25600\n    '26':\n      Memory: 26624\n    '27':\n      Memory: 27648\n    '28':\n      Memory: 28672\n    '29':\n      Memory: 29696\n    '30':\n      Memory: 30720\nConditions:\n  HasPermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundary, '']]\n  HasLoadBalancerHttps: !Equals [!Ref LoadBalancerHttps, 'true']\n  HasLoadBalancerPathPattern: !Not [!Equals [!Ref LoadBalancerPathPattern, '']]\n  HasLoadBalancerHostPattern: !Not [!Equals [!Ref LoadBalancerHostPattern, '']]\n  HasAlertTopic: !Not [!Equals [!Ref ParentAlertStack, '']]\n  HasZone: !Not [!Equals [!Ref ParentZoneStack, '']]\n  HasSubnetsReachPublic: !Equals [!Ref SubnetsReach, Public]\n  HasAutoScaling: !Equals [!Ref AutoScaling, 'true']\n  HasClientSecurityGroup1: !Not [!Equals [!Ref ParentClientStack1, '']]\n  HasClientSecurityGroup2: !Not [!Equals [!Ref ParentClientStack2, '']]\n  HasClientSecurityGroup3: !Not [!Equals [!Ref ParentClientStack3, '']]\n  HasTaskPolicies: !Not [!Equals [!Ref TaskPolicies, '']]\n  HasAppCommand: !Not [!Equals [!Ref AppCommand, '']]\n  HasAppEnvironment1Key: !Not [!Equals [!Ref AppEnvironment1Key, '']]\n  HasAppEnvironment2Key: !Not [!Equals [!Ref AppEnvironment2Key, '']]\n  HasAppEnvironment3Key: !Not [!Equals [!Ref AppEnvironment3Key, '']]\n  HasProxyImage: !Not [!Equals [!Ref ProxyImage, '']]\n  HasProxyCommand: !Not [!Equals [!Ref ProxyCommand, '']]\n  HasProxyEnvironment1Key: !Not [!Equals [!Ref ProxyEnvironment1Key, '']]\n  HasProxyEnvironment2Key: !Not [!Equals [!Ref ProxyEnvironment2Key, '']]\n  HasProxyEnvironment3Key: !Not [!Equals [!Ref ProxyEnvironment3Key, '']]\n  HasSidecarImage: !Not [!Equals [!Ref SidecarImage, '']]\n  HasSidecarCommand: !Not [!Equals [!Ref SidecarCommand, '']]\n  HasSidecarEnvironment1Key: !Not [!Equals [!Ref SidecarEnvironment1Key, '']]\n  HasSidecarEnvironment2Key: !Not [!Equals [!Ref SidecarEnvironment2Key, '']]\n  HasSidecarEnvironment3Key: !Not [!Equals [!Ref SidecarEnvironment3Key, '']]\nResources:\n  RecordSet:\n    Condition: HasZone\n    Type: 'AWS::Route53::RecordSet'\n    Properties:\n      AliasTarget:\n        HostedZoneId:\n          {\n            'Fn::ImportValue': !Sub '${ParentClusterStack}-CanonicalHostedZoneID'\n          }\n        DNSName: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-DNSName' }\n      HostedZoneId:\n        { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneId' }\n      Name: !Sub\n        - '${SubDomainNameWithDot}${HostedZoneName}'\n        - SubDomainNameWithDot: !Ref SubDomainNameWithDot\n          HostedZoneName:\n            { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneName' }\n      Type: A\n  RecordSetIPv6: # We can not conditionally create this only if the cluster's ALB has IPv6 turned on. Route53 does not let us query a broken AAAA record either. It just shows up as a Route53 record.\n    Condition: HasZone\n    Type: 'AWS::Route53::RecordSet'\n    Properties:\n      AliasTarget:\n        HostedZoneId:\n          {\n            'Fn::ImportValue': !Sub '${ParentClusterStack}-CanonicalHostedZoneID'\n          }\n        DNSName: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-DNSName' }\n      HostedZoneId:\n        { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneId' }\n      Name: !Sub\n        - '${SubDomainNameWithDot}${HostedZoneName}'\n        - SubDomainNameWithDot: !Ref SubDomainNameWithDot\n          HostedZoneName:\n            { 'Fn::ImportValue': !Sub '${ParentZoneStack}-HostedZoneName' }\n      Type: AAAA\n  TargetGroup:\n    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'\n    Properties:\n      HealthCheckIntervalSeconds: 15\n      HealthCheckPath: '/'\n      HealthCheckProtocol: HTTP\n      HealthCheckTimeoutSeconds: 10\n      HealthyThresholdCount: 2\n      UnhealthyThresholdCount: 2\n      Matcher:\n        HttpCode: '200-299'\n      Port: 8080 # overriden when containers are attached\n      Protocol: HTTP\n      TargetType: ip\n      TargetGroupAttributes:\n        - Key: deregistration_delay.timeout_seconds\n          Value: !Ref LoadBalancerDeregistrationDelay\n      VpcId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC' }\n  HTTPCodeTarget5XXTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Application load balancer receives 5XX HTTP status codes from targets'\n      Namespace: 'AWS/ApplicationELB'\n      MetricName: HTTPCode_Target_5XX_Count\n      Statistic: Sum\n      Period: 60\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 0\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: LoadBalancer\n          Value:\n            {\n              'Fn::ImportValue': !Sub '${ParentClusterStack}-LoadBalancerFullName'\n            }\n        - Name: TargetGroup\n          Value: !GetAtt TargetGroup.TargetGroupFullName\n      TreatMissingData: notBreaching\n  TargetConnectionErrorCountTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Application load balancer could not connect to targets'\n      Namespace: 'AWS/ApplicationELB'\n      MetricName: TargetConnectionErrorCount\n      Statistic: Sum\n      Period: 60\n      EvaluationPeriods: 1\n      ComparisonOperator: GreaterThanThreshold\n      Threshold: 0\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n      Dimensions:\n        - Name: LoadBalancer\n          Value:\n            {\n              'Fn::ImportValue': !Sub '${ParentClusterStack}-LoadBalancerFullName'\n            }\n        - Name: TargetGroup\n          Value: !GetAtt TargetGroup.TargetGroupFullName\n      TreatMissingData: notBreaching\n  LoadBalancerListenerRule:\n    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'\n    Properties:\n      Actions:\n        - Type: forward\n          TargetGroupArn: !Ref TargetGroup\n      Conditions: !If\n        - HasLoadBalancerPathPattern\n        - !If\n          - HasLoadBalancerHostPattern\n          - - Field: host-header\n              Values:\n                - !Ref LoadBalancerHostPattern\n            - Field: path-pattern\n              Values:\n                - !Sub '${LoadBalancerPathPattern}'\n          - - Field: path-pattern\n              Values:\n                - !Sub '${LoadBalancerPathPattern}'\n        - !If\n          - HasLoadBalancerHostPattern\n          - - Field: host-header\n              Values:\n                - !Ref LoadBalancerHostPattern\n          - [] # neither LoadBalancerHostPattern nor LoadBalancerPathPattern specified\n      ListenerArn:\n        !If [\n          HasLoadBalancerHttps,\n          { 'Fn::ImportValue': !Sub '${ParentClusterStack}-HttpsListener' },\n          { 'Fn::ImportValue': !Sub '${ParentClusterStack}-HttpListener' }\n        ]\n      Priority: !Ref LoadBalancerPriority\n  TaskExecutionRole:\n    Type: 'AWS::IAM::Role'\n    Properties:\n      AssumeRolePolicyDocument:\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: 'ecs-tasks.amazonaws.com'\n            Action: 'sts:AssumeRole'\n      PermissionsBoundary:\n        !If [\n          HasPermissionsBoundary,\n          !Ref PermissionsBoundary,\n          !Ref 'AWS::NoValue'\n        ]\n      Policies:\n        - PolicyName: AmazonECSTaskExecutionRolePolicy # https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html\n          PolicyDocument:\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'ecr:GetAuthorizationToken'\n                  - 'ecr:BatchCheckLayerAvailability'\n                  - 'ecr:GetDownloadUrlForLayer'\n                  - 'ecr:BatchGetImage'\n                Resource: '*'\n              - Effect: Allow\n                Action:\n                  - 'logs:CreateLogStream'\n                  - 'logs:PutLogEvents'\n                Resource: !GetAtt 'LogGroup.Arn'\n  TaskRole:\n    Type: 'AWS::IAM::Role'\n    Properties:\n      AssumeRolePolicyDocument:\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: 'ecs-tasks.amazonaws.com'\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        !If [\n          HasTaskPolicies,\n          !Split [',', !Ref TaskPolicies],\n          !Ref 'AWS::NoValue'\n        ]\n      PermissionsBoundary:\n        !If [\n          HasPermissionsBoundary,\n          !Ref PermissionsBoundary,\n          !Ref 'AWS::NoValue'\n        ]\n  TaskDefinition:\n    Type: 'AWS::ECS::TaskDefinition'\n    Properties:\n      ContainerDefinitions:\n        - !If\n          - HasProxyImage\n          - Name: proxy\n            Image: !Ref ProxyImage\n            Command:\n              !If [HasProxyCommand, !Ref ProxyCommand, !Ref 'AWS::NoValue']\n            PortMappings:\n              - ContainerPort: !Ref ProxyPort\n                Protocol: tcp\n            Essential: true\n            LogConfiguration:\n              LogDriver: awslogs\n              Options:\n                'awslogs-region': !Ref 'AWS::Region'\n                'awslogs-group': !Ref LogGroup\n                'awslogs-stream-prefix': proxy\n            Environment:\n              - !If [\n                  HasProxyEnvironment1Key,\n                  {\n                    Name: !Ref ProxyEnvironment1Key,\n                    Value: !Ref ProxyEnvironment1Value\n                  },\n                  !Ref 'AWS::NoValue'\n                ]\n              - !If [\n                  HasProxyEnvironment2Key,\n                  {\n                    Name: !Ref ProxyEnvironment2Key,\n                    Value: !Ref ProxyEnvironment2Value\n                  },\n                  !Ref 'AWS::NoValue'\n                ]\n              - !If [\n                  HasProxyEnvironment3Key,\n                  {\n                    Name: !Ref ProxyEnvironment3Key,\n                    Value: !Ref ProxyEnvironment3Value\n                  },\n                  !Ref 'AWS::NoValue'\n                ]\n          - !Ref 'AWS::NoValue'\n        - Name: app\n          Image: !Ref AppImage\n          Command:\n            !If [\n              HasAppCommand,\n              !Split [',', !Ref AppCommand],\n              !Ref 'AWS::NoValue'\n            ]\n          PortMappings:\n            - ContainerPort: !Ref AppPort\n              Protocol: tcp\n          Essential: true\n          LogConfiguration:\n            LogDriver: awslogs\n            Options:\n              'awslogs-region': !Ref 'AWS::Region'\n              'awslogs-group': !Ref LogGroup\n              'awslogs-stream-prefix': app\n          Environment:\n            - !If [\n                HasAppEnvironment1Key,\n                {\n                  Name: !Ref AppEnvironment1Key,\n                  Value: !Ref AppEnvironment1Value\n                },\n                !Ref 'AWS::NoValue'\n              ]\n            - !If [\n                HasAppEnvironment2Key,\n                {\n                  Name: !Ref AppEnvironment2Key,\n                  Value: !Ref AppEnvironment2Value\n                },\n                !Ref 'AWS::NoValue'\n              ]\n            - !If [\n                HasAppEnvironment3Key,\n                {\n                  Name: !Ref AppEnvironment3Key,\n                  Value: !Ref AppEnvironment3Value\n                },\n                !Ref 'AWS::NoValue'\n              ]\n        - !If\n          - HasSidecarImage\n          - Name: sidecar\n            Image: !Ref SidecarImage\n            Command:\n              !If [HasSidecarCommand, !Ref SidecarCommand, !Ref 'AWS::NoValue']\n            PortMappings:\n              - ContainerPort: !Ref SidecarPort\n                Protocol: tcp\n            Essential: true\n            LogConfiguration:\n              LogDriver: awslogs\n              Options:\n                'awslogs-region': !Ref 'AWS::Region'\n                'awslogs-group': !Ref LogGroup\n                'awslogs-stream-prefix': sidecar\n            Environment:\n              - !If [\n                  HasSidecarEnvironment1Key,\n                  {\n                    Name: !Ref SidecarEnvironment1Key,\n                    Value: !Ref SidecarEnvironment1Value\n                  },\n                  !Ref 'AWS::NoValue'\n                ]\n              - !If [\n                  HasSidecarEnvironment2Key,\n                  {\n                    Name: !Ref SidecarEnvironment2Key,\n                    Value: !Ref SidecarEnvironment2Value\n                  },\n                  !Ref 'AWS::NoValue'\n                ]\n              - !If [\n                  HasSidecarEnvironment3Key,\n                  {\n                    Name: !Ref SidecarEnvironment3Key,\n                    Value: !Ref SidecarEnvironment3Value\n                  },\n                  !Ref 'AWS::NoValue'\n                ]\n          - !Ref 'AWS::NoValue'\n      Cpu: !FindInMap [CpuMap, !Ref Cpu, Cpu]\n      ExecutionRoleArn: !GetAtt 'TaskExecutionRole.Arn'\n      Family: !Ref 'ServiceName'\n      Memory: !FindInMap [MemoryMap, !Ref Memory, Memory]\n      NetworkMode: awsvpc\n      RequiresCompatibilities: [FARGATE]\n      TaskRoleArn: !GetAtt 'TaskRole.Arn'\n  LogGroup:\n    Type: 'AWS::Logs::LogGroup'\n    Properties:\n      RetentionInDays: !Ref LogsRetentionInDays\n  ServiceSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: !Sub '${AWS::StackName}-service'\n      VpcId: { 'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC' }\n      SecurityGroupIngress:\n        - SourceSecurityGroupId:\n            {\n              'Fn::ImportValue': !Sub '${ParentClusterStack}-LoadBalancerSecurityGroup'\n            }\n          FromPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]\n          ToPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]\n          IpProtocol: tcp\n  Service:\n    DependsOn: LoadBalancerListenerRule\n    Type: 'AWS::ECS::Service'\n    Properties:\n      ServiceName: !Ref 'ServiceName'\n      Cluster: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-Cluster' }\n      DeploymentConfiguration:\n        MaximumPercent: 200\n        MinimumHealthyPercent: 100\n      DesiredCount: !Ref DesiredCount\n      HealthCheckGracePeriodSeconds: !Ref HealthCheckGracePeriod\n      LaunchType: FARGATE\n      LoadBalancers:\n        - ContainerName: !If [HasProxyImage, proxy, app]\n          ContainerPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]\n          TargetGroupArn: !Ref TargetGroup\n      NetworkConfiguration:\n        AwsvpcConfiguration:\n          AssignPublicIp: !If [HasSubnetsReachPublic, ENABLED, DISABLED]\n          SecurityGroups:\n            - !Ref ServiceSecurityGroup\n            - !If [\n                HasClientSecurityGroup1,\n                {\n                  'Fn::ImportValue': !Sub '${ParentClientStack1}-ClientSecurityGroup'\n                },\n                !Ref 'AWS::NoValue'\n              ]\n            - !If [\n                HasClientSecurityGroup2,\n                {\n                  'Fn::ImportValue': !Sub '${ParentClientStack2}-ClientSecurityGroup'\n                },\n                !Ref 'AWS::NoValue'\n              ]\n            - !If [\n                HasClientSecurityGroup3,\n                {\n                  'Fn::ImportValue': !Sub '${ParentClientStack3}-ClientSecurityGroup'\n                },\n                !Ref 'AWS::NoValue'\n              ]\n          Subnets:\n            !Split [\n              ',',\n              {\n                'Fn::ImportValue': !Sub '${ParentVPCStack}-Subnets${SubnetsReach}'\n              }\n            ]\n      PlatformVersion: '1.4.0'\n      TaskDefinition: !Ref TaskDefinition\n  CPUUtilizationTooHighAlarm:\n    Condition: HasAlertTopic\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Average CPU utilization over last 10 minutes higher than 80%'\n      Namespace: 'AWS/ECS'\n      Dimensions:\n        - Name: ClusterName\n          Value: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-Cluster' }\n        - Name: ServiceName\n          Value: !Ref 'ServiceName'\n      MetricName: CPUUtilization\n      ComparisonOperator: GreaterThanThreshold\n      Statistic: Average\n      Period: 300\n      EvaluationPeriods: 1\n      Threshold: 80\n      AlarmActions:\n        - { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n  ServiceFailedNotification:\n    Condition: HasAlertTopic\n    Type: 'AWS::Events::Rule'\n    Properties:\n      EventPattern:\n        source:\n          - 'aws.ec2'\n        'detail-type':\n          - 'ECS Service Action'\n        resources:\n          - !Ref Service\n        detail:\n          eventType:\n            - ERROR\n            - WARN\n      State: ENABLED\n      Targets:\n        - Arn: { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n          Id: rule\n  ScalableTargetRole: # based on http://docs.aws.amazon.com/AmazonECS/latest/developerguide/autoscale_IAM_role.html\n    Condition: HasAutoScaling\n    Type: 'AWS::IAM::Role'\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: 'application-autoscaling.amazonaws.com'\n            Action: 'sts:AssumeRole'\n      PermissionsBoundary:\n        !If [\n          HasPermissionsBoundary,\n          !Ref PermissionsBoundary,\n          !Ref 'AWS::NoValue'\n        ]\n      Policies:\n        - PolicyName: AmazonEC2ContainerServiceAutoscaleRole\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'ecs:DescribeServices'\n                  - 'ecs:UpdateService'\n                Resource: '*'\n        - PolicyName: cloudwatch\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'cloudwatch:DescribeAlarms'\n                Resource: '*'\n  ScalableTarget:\n    Condition: HasAutoScaling\n    Type: 'AWS::ApplicationAutoScaling::ScalableTarget'\n    Properties:\n      MaxCapacity: !Ref MaxCapacity\n      MinCapacity: !Ref MinCapacity\n      ResourceId: !Sub\n        - 'service/${Cluster}/${Service}'\n        - Cluster: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-Cluster' }\n          Service: !Ref 'ServiceName'\n      RoleARN: !GetAtt 'ScalableTargetRole.Arn'\n      ScalableDimension: 'ecs:service:DesiredCount'\n      ServiceNamespace: ecs\n  ScaleUpPolicy:\n    Condition: HasAutoScaling\n    Type: 'AWS::ApplicationAutoScaling::ScalingPolicy'\n    Properties:\n      PolicyName: !Sub '${AWS::StackName}-scale-up'\n      PolicyType: StepScaling\n      ScalingTargetId: !Ref ScalableTarget\n      StepScalingPolicyConfiguration:\n        AdjustmentType: PercentChangeInCapacity\n        Cooldown: 300\n        MinAdjustmentMagnitude: 1\n        StepAdjustments:\n          - MetricIntervalLowerBound: 0\n            ScalingAdjustment: 25\n  ScaleDownPolicy:\n    Condition: HasAutoScaling\n    Type: 'AWS::ApplicationAutoScaling::ScalingPolicy'\n    Properties:\n      PolicyName: !Sub '${AWS::StackName}-scale-down'\n      PolicyType: StepScaling\n      ScalingTargetId: !Ref ScalableTarget\n      StepScalingPolicyConfiguration:\n        AdjustmentType: PercentChangeInCapacity\n        Cooldown: 300\n        MinAdjustmentMagnitude: 1\n        StepAdjustments:\n          - MetricIntervalUpperBound: 0\n            ScalingAdjustment: -25\n  CPUUtilizationHighAlarm:\n    Condition: HasAutoScaling\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Service is running out of CPU'\n      Namespace: 'AWS/ECS'\n      Dimensions:\n        - Name: ClusterName\n          Value: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-Cluster' }\n        - Name: ServiceName\n          Value: !Ref 'ServiceName'\n      MetricName: CPUUtilization\n      ComparisonOperator: GreaterThanThreshold\n      Statistic: Average\n      Period: 300\n      EvaluationPeriods: 1\n      Threshold: 60\n      AlarmActions:\n        - !Ref ScaleUpPolicy\n  CPUUtilizationLowAlarm:\n    Condition: HasAutoScaling\n    Type: 'AWS::CloudWatch::Alarm'\n    Properties:\n      AlarmDescription: 'Service is wasting CPU'\n      Namespace: 'AWS/ECS'\n      Dimensions:\n        - Name: ClusterName\n          Value: { 'Fn::ImportValue': !Sub '${ParentClusterStack}-Cluster' }\n        - Name: ServiceName\n          Value: !Ref 'ServiceName'\n      MetricName: CPUUtilization\n      ComparisonOperator: LessThanThreshold\n      Statistic: Average\n      Period: 300\n      EvaluationPeriods: 3\n      Threshold: 30\n      AlarmActions:\n        - !Ref ScaleDownPolicy\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'fargate/service-cluster-alb'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '__VERSION__'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "aws_cloudformation_stack.client_sg",
            "aws_cloudformation_stack.ecs_cluster",
            "aws_cloudformation_stack.vpc"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "key-store",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-kms-stack-final/84171e20-700f-11eb-80bd-12f057d255e7",
            "name": "commons-kms-stack-final",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "KeyArn": "arn:aws:kms:us-east-1:246369665268:key/00783b18-5cdd-48b8-ae4b-05fff649584b",
              "KeyId": "00783b18-5cdd-48b8-ae4b-05fff649584b",
              "StackName": "commons-kms-stack-final",
              "TemplateID": "security/kms-key",
              "TemplateVersion": "13.4.0"
            },
            "parameters": {},
            "policy_body": null,
            "policy_url": null,
            "tags": {},
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'Security: KMS customer managed CMK for AWS services, a cloudonaut.io template'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'Parent Stacks'\n        Parameters:\n          - ParentAlertStack\n      - Label:\n          default: 'KMS Parameters'\n        Parameters:\n          - Service\nParameters:\n  ParentAlertStack:\n    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'\n    Type: String\n    Default: ''\n  Service:\n    Description: 'Which AWS service is allowed to use this CMK?'\n    Type: String\n    AllowedValues:\n      - 'ALL_SERVICES'\n      - 'S3_PUBLIC_ACCESS'\n      - connect\n      - dms\n      - ssm\n      - ec2\n      - elasticfilesystem\n      - es\n      - kinesis\n      - kinesisvideo\n      - lambda\n      - lex\n      - redshift\n      - rds\n      - secretsmanager\n      - ses\n      - s3\n      - importexport\n      - sqs\n      - workmail\n      - workspaces\n    Default: ALL_SERVICES\nConditions:\n  HasAlertTopic: !Not [!Equals [!Ref ParentAlertStack, '']]\n  HasServiceAllServices: !Equals [!Ref Service, 'ALL_SERVICES']\n  HasServiceS3PublicAccess: !Equals [!Ref Service, 'S3_PUBLIC_ACCESS']\nResources:\n  Key:\n    DeletionPolicy: Retain\n    UpdateReplacePolicy: Retain\n    Type: 'AWS::KMS::Key'\n    Properties:\n      EnableKeyRotation: true\n      KeyPolicy:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'\n            Action: 'kms:*'\n            Resource: '*'\n          - Effect: Allow\n            Principal:\n              AWS: '*'\n            Action:\n              - 'kms:Encrypt'\n              - 'kms:Decrypt'\n              - 'kms:ReEncrypt*'\n              - 'kms:GenerateDataKey*'\n              - 'kms:CreateGrant'\n              - 'kms:ListGrants'\n              - 'kms:DescribeKey'\n            Resource: '*'\n            Condition:\n              StringEquals: !If\n                - HasServiceAllServices\n                - 'kms:CallerAccount': !Ref 'AWS::AccountId'\n                - 'kms:CallerAccount': !Ref 'AWS::AccountId'\n                  'kms:ViaService': !Sub '${Service}.${AWS::Region}.amazonaws.com'\n          - !If\n            - HasServiceS3PublicAccess\n            - Effect: Allow\n              Principal:\n                AWS: '*'\n              Action:\n                - 'kms:Decrypt'\n              Resource: '*'\n              Condition:\n                StringEquals:\n                  'kms:ViaService': !Sub 's3.${AWS::Region}.amazonaws.com'\n            - !Ref 'AWS::NoValue'\n  KeyAlias:\n    DeletionPolicy: Retain\n    UpdateReplacePolicy: Retain\n    Type: 'AWS::KMS::Alias'\n    Properties:\n      AliasName: !Sub 'alias/${AWS::StackName}'\n      TargetKeyId: !Ref Key\n  DeletionNotification:\n    Condition: HasAlertTopic\n    Type: 'AWS::Events::Rule'\n    Properties:\n      EventPattern:\n        source:\n          - 'aws.kms'\n        'detail-type':\n          - 'AWS API Call via CloudTrail'\n        resources:\n          - !GetAtt Key.Arn\n        detail:\n          eventSource:\n            - 'kms.amazonaws.com'\n          'eventName':\n            - ScheduleKeyDeletion\n            - DisableKey\n      State: ENABLED\n      Targets:\n        - Arn: { 'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN' }\n          Id: rule\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'security/kms-key'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '13.4.0'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n  KeyId:\n    Description: 'Key id.'\n    Value: !Ref Key\n    Export:\n      Name: !Sub '${AWS::StackName}-KeyId'\n  KeyArn:\n    Description: 'Key ARN.'\n    Value: !GetAtt 'Key.Arn'\n    Export:\n      Name: !Sub '${AWS::StackName}-KeyArn'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "create_before_destroy": true
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudformation_stack",
      "name": "vpc",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "capabilities": [
              "CAPABILITY_NAMED_IAM"
            ],
            "disable_rollback": false,
            "iam_role_arn": "",
            "id": "arn:aws:cloudformation:us-east-1:246369665268:stack/commons-vpc-stack/d5853e10-7017-11eb-8ae3-123e22873efd",
            "name": "commons-vpc-stack",
            "notification_arns": null,
            "on_failure": null,
            "outputs": {
              "AZA": "us-east-1a",
              "AZB": "us-east-1b",
              "AZList": "us-east-1a,us-east-1b",
              "AZs": "2",
              "CidrBlock": "10.0.0.0/16",
              "CidrBlockIPv6": "2600:1f18:39d:1600::/56",
              "InternetGateway": "igw-0648e2c5ec45d1c15",
              "RouteTableAPrivate": "rtb-06449fadb6b51c5b7",
              "RouteTableAPublic": "rtb-029cdda5e2d6fde3d",
              "RouteTableBPrivate": "rtb-0abfd57e13d08b2c1",
              "RouteTableBPublic": "rtb-0c6ca1591d5a112f6",
              "RouteTablesPrivate": "rtb-06449fadb6b51c5b7,rtb-0abfd57e13d08b2c1",
              "RouteTablesPublic": "rtb-029cdda5e2d6fde3d,rtb-0c6ca1591d5a112f6",
              "StackName": "commons-vpc-stack",
              "SubnetAPrivate": "subnet-0b9ca814866dd6886",
              "SubnetAPublic": "subnet-06e19ce011bbd155b",
              "SubnetBPrivate": "subnet-0f168a31d6128d7ac",
              "SubnetBPublic": "subnet-029040fa45a5856d9",
              "SubnetsPrivate": "subnet-0b9ca814866dd6886,subnet-0f168a31d6128d7ac",
              "SubnetsPublic": "subnet-06e19ce011bbd155b,subnet-029040fa45a5856d9",
              "TemplateID": "vpc/vpc-2azs",
              "TemplateVersion": "13.4.0",
              "VPC": "vpc-0e3d52d4e3fcb016a"
            },
            "parameters": {},
            "policy_body": null,
            "policy_url": null,
            "tags": {},
            "template_body": "---\n# Copyright 2018 widdix GmbH\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'VPC: public and private subnets in two availability zones, a cloudonaut.io template'\nMetadata:\n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: 'VPC Parameters'\n        Parameters:\n          - ClassB\nParameters:\n  ClassB:\n    Description: 'Class B of VPC (10.XXX.0.0/16)'\n    Type: Number\n    Default: 0\n    ConstraintDescription: 'Must be in the range [0-255]'\n    MinValue: 0\n    MaxValue: 255\n  # Name:\n  #   Description: 'The name of the domain (hosted zone).'\n  #   Type: String\nResources:\n  # HostedZone:\n  #   Type: 'AWS::Route53::HostedZone'\n  #   Properties:\n  #     HostedZoneConfig:\n  #       Comment: !Sub '${Name} public DNS zone'\n  #     Name: !Ref Name\n  VPC:\n    Type: 'AWS::EC2::VPC'\n    Properties:\n      CidrBlock: !Sub '10.${ClassB}.0.0/16'\n      EnableDnsSupport: true\n      EnableDnsHostnames: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Sub '10.${ClassB}.0.0/16'\n  VPCCidrBlock:\n    Type: 'AWS::EC2::VPCCidrBlock'\n    Properties:\n      AmazonProvidedIpv6CidrBlock: true\n      VpcId: !Ref VPC\n  InternetGateway:\n    Type: 'AWS::EC2::InternetGateway'\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub '10.${ClassB}.0.0/16'\n  EgressOnlyInternetGateway:\n    Type: 'AWS::EC2::EgressOnlyInternetGateway'\n    Properties:\n      VpcId: !Ref VPC\n  VPCGatewayAttachment:\n    Type: 'AWS::EC2::VPCGatewayAttachment'\n    Properties:\n      VpcId: !Ref VPC\n      InternetGatewayId: !Ref InternetGateway\n  SubnetAPublic:\n    DependsOn: VPCCidrBlock\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      #AssignIpv6AddressOnCreation: true # TODO can not be set if MapPublicIpOnLaunch is true as well\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Sub '10.${ClassB}.0.0/20'\n      Ipv6CidrBlock:\n        !Select [0, !Cidr [!Select [0, !GetAtt 'VPC.Ipv6CidrBlocks'], 4, 64]]\n      MapPublicIpOnLaunch: true\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'A public'\n        - Key: Reach\n          Value: public\n  SubnetAPrivate:\n    DependsOn: VPCCidrBlock\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      AssignIpv6AddressOnCreation: false\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Sub '10.${ClassB}.16.0/20'\n      Ipv6CidrBlock:\n        !Select [1, !Cidr [!Select [0, !GetAtt 'VPC.Ipv6CidrBlocks'], 4, 64]]\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'A private'\n        - Key: Reach\n          Value: private\n  SubnetBPublic:\n    DependsOn: VPCCidrBlock\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      #AssignIpv6AddressOnCreation: true # TODO can not be set if MapPublicIpOnLaunch is true as well\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Sub '10.${ClassB}.32.0/20'\n      Ipv6CidrBlock:\n        !Select [2, !Cidr [!Select [0, !GetAtt 'VPC.Ipv6CidrBlocks'], 4, 64]]\n      MapPublicIpOnLaunch: true\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'B public'\n        - Key: Reach\n          Value: public\n  SubnetBPrivate:\n    DependsOn: VPCCidrBlock\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      AssignIpv6AddressOnCreation: false\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Sub '10.${ClassB}.48.0/20'\n      Ipv6CidrBlock:\n        !Select [3, !Cidr [!Select [0, !GetAtt 'VPC.Ipv6CidrBlocks'], 4, 64]]\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'B private'\n        - Key: Reach\n          Value: private\n  RouteTablePublic: # should be RouteTableAPublic, but logical id was not changed for backward compatibility\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'A Public'\n  RouteTablePrivate: # should be RouteTableAPrivate, but logical id was not changed for backward compatibility\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'A Private'\n  RouteTableBPublic:\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'B Public'\n  RouteTableBPrivate:\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: 'B Private'\n  RouteTableAssociationAPublic:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref SubnetAPublic\n      RouteTableId: !Ref RouteTablePublic\n  RouteTableAssociationAPrivate:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref SubnetAPrivate\n      RouteTableId: !Ref RouteTablePrivate\n  RouteTableAssociationBPublic:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref SubnetBPublic\n      RouteTableId: !Ref RouteTableBPublic\n  RouteTableAssociationBPrivate:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref SubnetBPrivate\n      RouteTableId: !Ref RouteTableBPrivate\n  RouteTablePublicInternetRoute: # should be RouteTablePublicAInternetRoute, but logical id was not changed for backward compatibility\n    Type: 'AWS::EC2::Route'\n    DependsOn: VPCGatewayAttachment\n    Properties:\n      RouteTableId: !Ref RouteTablePublic\n      DestinationCidrBlock: '0.0.0.0/0'\n      GatewayId: !Ref InternetGateway\n  RouteTablePublicAInternetRouteIPv6:\n    Type: 'AWS::EC2::Route'\n    DependsOn: VPCGatewayAttachment\n    Properties:\n      RouteTableId: !Ref RouteTablePublic\n      DestinationIpv6CidrBlock: '::/0'\n      GatewayId: !Ref InternetGateway\n  RouteTablePrivateAInternetRouteIPv6:\n    Type: 'AWS::EC2::Route'\n    Properties:\n      RouteTableId: !Ref RouteTablePrivate\n      DestinationIpv6CidrBlock: '::/0'\n      EgressOnlyInternetGatewayId: !Ref EgressOnlyInternetGateway\n  RouteTablePublicBInternetRoute:\n    Type: 'AWS::EC2::Route'\n    DependsOn: VPCGatewayAttachment\n    Properties:\n      RouteTableId: !Ref RouteTableBPublic\n      DestinationCidrBlock: '0.0.0.0/0'\n      GatewayId: !Ref InternetGateway\n  RouteTablePublicBInternetRouteIPv6:\n    Type: 'AWS::EC2::Route'\n    DependsOn: VPCGatewayAttachment\n    Properties:\n      RouteTableId: !Ref RouteTableBPublic\n      DestinationIpv6CidrBlock: '::/0'\n      GatewayId: !Ref InternetGateway\n  RouteTablePrivateBInternetRouteIPv6:\n    Type: 'AWS::EC2::Route'\n    Properties:\n      RouteTableId: !Ref RouteTableBPrivate\n      DestinationIpv6CidrBlock: '::/0'\n      EgressOnlyInternetGatewayId: !Ref EgressOnlyInternetGateway\n  NetworkAclPublic:\n    Type: 'AWS::EC2::NetworkAcl'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: Public\n  NetworkAclPrivate:\n    Type: 'AWS::EC2::NetworkAcl'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: Private\n  SubnetNetworkAclAssociationAPublic:\n    Type: 'AWS::EC2::SubnetNetworkAclAssociation'\n    Properties:\n      SubnetId: !Ref SubnetAPublic\n      NetworkAclId: !Ref NetworkAclPublic\n  SubnetNetworkAclAssociationAPrivate:\n    Type: 'AWS::EC2::SubnetNetworkAclAssociation'\n    Properties:\n      SubnetId: !Ref SubnetAPrivate\n      NetworkAclId: !Ref NetworkAclPrivate\n  SubnetNetworkAclAssociationBPublic:\n    Type: 'AWS::EC2::SubnetNetworkAclAssociation'\n    Properties:\n      SubnetId: !Ref SubnetBPublic\n      NetworkAclId: !Ref NetworkAclPublic\n  SubnetNetworkAclAssociationBPrivate:\n    Type: 'AWS::EC2::SubnetNetworkAclAssociation'\n    Properties:\n      SubnetId: !Ref SubnetBPrivate\n      NetworkAclId: !Ref NetworkAclPrivate\n  NetworkAclEntryInPublicAllowAll:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPublic\n      RuleNumber: 99\n      Protocol: -1\n      RuleAction: allow\n      Egress: false\n      CidrBlock: '0.0.0.0/0'\n  NetworkAclEntryInPublicAllowAllIPv6:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPublic\n      RuleNumber: 98\n      Protocol: -1\n      RuleAction: allow\n      Egress: false\n      Ipv6CidrBlock: '::/0'\n  NetworkAclEntryOutPublicAllowAll:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPublic\n      RuleNumber: 99\n      Protocol: -1\n      RuleAction: allow\n      Egress: true\n      CidrBlock: '0.0.0.0/0'\n  NetworkAclEntryOutPublicAllowAllIPv6:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPublic\n      RuleNumber: 98\n      Protocol: -1\n      RuleAction: allow\n      Egress: true\n      Ipv6CidrBlock: '::/0'\n  NetworkAclEntryInPrivateAllowAll:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPrivate\n      RuleNumber: 99\n      Protocol: -1\n      RuleAction: allow\n      Egress: false\n      CidrBlock: '0.0.0.0/0'\n  NetworkAclEntryInPrivateAllowAllIPv6:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPrivate\n      RuleNumber: 98\n      Protocol: -1\n      RuleAction: allow\n      Egress: false\n      Ipv6CidrBlock: '::/0'\n  NetworkAclEntryOutPrivateAllowAll:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPrivate\n      RuleNumber: 99\n      Protocol: -1\n      RuleAction: allow\n      Egress: true\n      CidrBlock: '0.0.0.0/0'\n  NetworkAclEntryOutPrivateAllowAllIPv6:\n    Type: 'AWS::EC2::NetworkAclEntry'\n    Properties:\n      NetworkAclId: !Ref NetworkAclPrivate\n      RuleNumber: 98\n      Protocol: -1\n      RuleAction: allow\n      Egress: true\n      Ipv6CidrBlock: '::/0'\nOutputs:\n  TemplateID:\n    Description: 'cloudonaut.io template id.'\n    Value: 'vpc/vpc-2azs'\n  TemplateVersion:\n    Description: 'cloudonaut.io template version.'\n    Value: '13.4.0'\n  StackName:\n    Description: 'Stack name.'\n    Value: !Sub '${AWS::StackName}'\n  AZs: # Better name would be NumberOfAZs, but we keep the name for backward compatibility\n    Description: 'Number of AZs'\n    Value: 2\n    Export:\n      Name: !Sub '${AWS::StackName}-AZs'\n  AZList: # Better name would be AZs, but the name was already used\n    Description: 'List of AZs'\n    Value: !Join [',', [!Select [0, !GetAZs ''], !Select [1, !GetAZs '']]]\n    Export:\n      Name: !Sub '${AWS::StackName}-AZList'\n  AZA:\n    Description: 'AZ of A'\n    Value: !Select [0, !GetAZs '']\n    Export:\n      Name: !Sub '${AWS::StackName}-AZA'\n  AZB:\n    Description: 'AZ of B'\n    Value: !Select [1, !GetAZs '']\n    Export:\n      Name: !Sub '${AWS::StackName}-AZB'\n  CidrBlock:\n    Description: 'The set of IP addresses for the VPC.'\n    Value: !GetAtt 'VPC.CidrBlock'\n    Export:\n      Name: !Sub '${AWS::StackName}-CidrBlock'\n  CidrBlockIPv6:\n    Description: 'The set of IPv6 addresses for the VPC.'\n    Value: !Select [0, !GetAtt 'VPC.Ipv6CidrBlocks']\n    Export:\n      Name: !Sub '${AWS::StackName}-CidrBlockIPv6'\n  VPC:\n    Description: 'VPC.'\n    Value: !Ref VPC\n    Export:\n      Name: !Sub '${AWS::StackName}-VPC'\n  InternetGateway:\n    Description: 'InternetGateway.'\n    Value: !Ref InternetGateway\n    Export:\n      Name: !Sub '${AWS::StackName}-InternetGateway'\n  SubnetsPublic:\n    Description: 'Subnets public.'\n    Value: !Join [',', [!Ref SubnetAPublic, !Ref SubnetBPublic]]\n    Export:\n      Name: !Sub '${AWS::StackName}-SubnetsPublic'\n  SubnetsPrivate:\n    Description: 'Subnets private.'\n    Value: !Join [',', [!Ref SubnetAPrivate, !Ref SubnetBPrivate]]\n    Export:\n      Name: !Sub '${AWS::StackName}-SubnetsPrivate'\n  RouteTablesPrivate:\n    Description: 'Route tables private.'\n    Value: !Join [',', [!Ref RouteTablePrivate, !Ref RouteTableBPrivate]]\n    Export:\n      Name: !Sub '${AWS::StackName}-RouteTablesPrivate'\n  RouteTablesPublic:\n    Description: 'Route tables public.'\n    Value: !Join [',', [!Ref RouteTablePublic, !Ref RouteTableBPublic]]\n    Export:\n      Name: !Sub '${AWS::StackName}-RouteTablesPublic'\n  SubnetAPublic:\n    Description: 'Subnet A public.'\n    Value: !Ref SubnetAPublic\n    Export:\n      Name: !Sub '${AWS::StackName}-SubnetAPublic'\n  RouteTableAPublic:\n    Description: 'Route table A public.'\n    Value: !Ref RouteTablePublic\n    Export:\n      Name: !Sub '${AWS::StackName}-RouteTableAPublic'\n  SubnetAPrivate:\n    Description: 'Subnet A private.'\n    Value: !Ref SubnetAPrivate\n    Export:\n      Name: !Sub '${AWS::StackName}-SubnetAPrivate'\n  RouteTableAPrivate:\n    Description: 'Route table A private.'\n    Value: !Ref RouteTablePrivate\n    Export:\n      Name: !Sub '${AWS::StackName}-RouteTableAPrivate'\n  SubnetBPublic:\n    Description: 'Subnet B public.'\n    Value: !Ref SubnetBPublic\n    Export:\n      Name: !Sub '${AWS::StackName}-SubnetBPublic'\n  RouteTableBPublic:\n    Description: 'Route table B public.'\n    Value: !Ref RouteTableBPublic\n    Export:\n      Name: !Sub '${AWS::StackName}-RouteTableBPublic'\n  SubnetBPrivate:\n    Description: 'Subnet B private.'\n    Value: !Ref SubnetBPrivate\n    Export:\n      Name: !Sub '${AWS::StackName}-SubnetBPrivate'\n  RouteTableBPrivate:\n    Description: 'Route table B private.'\n    Value: !Ref RouteTableBPrivate\n    Export:\n      Name: !Sub '${AWS::StackName}-RouteTableBPrivate'\n",
            "template_url": null,
            "timeout_in_minutes": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "create_before_destroy": true
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_ecr_repository",
      "name": "main-repo",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:ecr:us-east-1:246369665268:repository/commons",
            "encryption_configuration": [
              {
                "encryption_type": "AES256",
                "kms_key": ""
              }
            ],
            "id": "commons",
            "image_scanning_configuration": [
              {
                "scan_on_push": false
              }
            ],
            "image_tag_mutability": "IMMUTABLE",
            "name": "commons",
            "registry_id": "246369665268",
            "repository_url": "246369665268.dkr.ecr.us-east-1.amazonaws.com/commons",
            "tags": {},
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiZGVsZXRlIjoxMjAwMDAwMDAwMDAwfX0="
        }
      ]
    }
  ]
}
